<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripture Unlocked &mdash; Command Center</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: #060d1f;
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(59,130,246,0.07) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 80%, rgba(234,179,8,0.05) 0%, transparent 50%);
    color: #f1f5f9;
    min-height: 100vh;
  }

  /* PASSWORD */
  #passwordScreen { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
  .pw-box {
    background: linear-gradient(145deg, #0d1a35, #111827);
    border: 1px solid rgba(59,130,246,0.4);
    border-radius: 20px; padding: 52px; text-align: center;
    max-width: 400px; width: 90%;
    box-shadow: 0 0 60px rgba(59,130,246,0.1), 0 20px 60px rgba(0,0,0,0.5);
  }
  .pw-logo { font-size: 2rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 6px; color: #fff; }
  .pw-logo span { color: #eab308; }
  .pw-sub { color: #94a3b8; font-size: 0.8rem; margin-bottom: 32px; letter-spacing: 1px; text-transform: uppercase; }
  .pw-input {
    width: 100%; padding: 14px 18px;
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
    border-radius: 10px; color: #f1f5f9; font-size: 1rem; font-family: inherit;
    margin-bottom: 14px; outline: none;
  }
  .pw-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
  .pw-btn {
    width: 100%; padding: 14px; background: #1d4ed8; border: none; border-radius: 10px;
    color: #fff; font-size: 1rem; font-weight: 700; font-family: inherit;
    cursor: pointer; transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(59,130,246,0.35);
  }
  .pw-btn:hover { background: #2563eb; }
  .pw-error { color: #f87171; font-size: 0.85rem; margin-top: 12px; display: none; }

  /* DASHBOARD */
  #dashboard { display: none; }

  header {
    background: rgba(6,13,31,0.98);
    border-bottom: 1px solid rgba(59,130,246,0.2);
    padding: 18px 32px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(20px);
    flex-wrap: wrap; gap: 12px;
  }
  .header-left h1 { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; color: #fff; }
  .header-left h1 span { color: #eab308; }
  .header-meta { font-size: 0.7rem; color: #64748b; margin-top: 3px; letter-spacing: 0.5px; }

  .header-badge {
    background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.05));
    border: 1px solid rgba(59,130,246,0.3);
    border-radius: 12px; padding: 12px 24px; text-align: center;
  }
  .badge-label { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.5px; }
  .badge-value { font-size: 1.4rem; font-weight: 800; color: #60a5fa; line-height: 1.2; }
  .badge-sub { font-size: 0.72rem; color: #64748b; margin-top: 2px; }

  .main-content { padding: 28px 32px; max-width: 1400px; margin: 0 auto; }

  .section-title {
    font-size: 0.7rem; font-weight: 700; color: #64748b;
    text-transform: uppercase; letter-spacing: 2px;
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
  }
  .section-title::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.06); }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
  }
  .metric-card {
    background: linear-gradient(145deg, #0d1a35, #111827);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 16px; padding: 22px 20px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .metric-card:hover { border-color: rgba(59,130,246,0.3); box-shadow: 0 4px 20px rgba(59,130,246,0.08); }
  .metric-card.highlight { border-color: rgba(59,130,246,0.3); background: linear-gradient(145deg, #0d1529, #0f1829); }
  .metric-label { font-size: 0.68rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
  .metric-value { font-size: 2.2rem; font-weight: 800; color: #fff; line-height: 1; }
  .metric-value.accent { color: #60a5fa; text-shadow: 0 0 15px rgba(59,130,246,0.3); }
  .metric-value.gold { color: #eab308; text-shadow: 0 0 15px rgba(234,179,8,0.3); }
  .metric-sub { font-size: 0.75rem; color: #64748b; margin-top: 6px; }
  .last-updated { font-size: 0.7rem; color: #334155; margin-top: 4px; }

  /* STATUS CARDS */
  .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
  }
  .status-card {
    background: linear-gradient(145deg, #0d1a35, #111827);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 16px; padding: 22px 24px;
  }
  .status-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .status-name { font-size: 0.9rem; font-weight: 700; color: #f1f5f9; }
  .status-pill {
    padding: 4px 12px; border-radius: 99px; font-size: 0.68rem; font-weight: 600;
  }
  .status-pill.active { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.3); }
  .status-pill.dev { background: rgba(234,179,8,0.12); color: #fbbf24; border: 1px solid rgba(234,179,8,0.25); }
  .status-pill.live { background: rgba(34,197,94,0.12); color: #4ade80; border: 1px solid rgba(34,197,94,0.2); }
  .status-desc { font-size: 0.8rem; color: #64748b; line-height: 1.5; }
  .status-link { font-size: 0.78rem; color: #3b82f6; margin-top: 8px; display: block; text-decoration: none; }
  .status-link:hover { color: #60a5fa; }

  /* STAGING FILES */
  .files-card {
    background: linear-gradient(145deg, #0d1a35, #111827);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 16px; padding: 24px 28px;
    margin-bottom: 28px;
  }
  .file-list { display: flex; flex-direction: column; gap: 8px; margin-top: 14px; }
  .file-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; border-radius: 10px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    font-size: 0.82rem; color: #94a3b8;
  }
  .file-icon { font-size: 1rem; flex-shrink: 0; }
  .file-name { flex: 1; font-family: monospace; font-size: 0.8rem; }
  .file-empty { color: #334155; font-style: italic; font-size: 0.82rem; padding: 10px 14px; }

  .refresh-btn {
    background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.25);
    color: #60a5fa; border-radius: 8px; padding: 8px 16px;
    font-size: 0.78rem; font-weight: 600; font-family: inherit; cursor: pointer;
    transition: all 0.2s;
  }
  .refresh-btn:hover { background: rgba(59,130,246,0.2); }
  .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  @media (max-width: 640px) {
    header { padding: 14px 16px; }
    .main-content { padding: 16px; }
    .metrics-grid { grid-template-columns: repeat(2, 1fr); }
  }
  </style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="passwordScreen">
  <div class="pw-box">
    <div class="pw-logo">SCRIPTURE <span>UNLOCKED</span></div>
    <div class="pw-sub">Command Center &bull; Content Tracker</div>
    <input type="password" class="pw-input" id="pwInput" placeholder="Enter access code" onkeydown="if(event.key==='Enter')checkPw()">
    <button class="pw-btn" onclick="checkPw()">Enter</button>
    <div class="pw-error" id="pwError">Incorrect code</div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header>
    <div class="header-left">
      <h1>SCRIPTURE <span>UNLOCKED</span></h1>
      <div class="header-meta">Content Command Center &bull; markwasmuth.com/cc/SU</div>
    </div>
    <div class="header-badge">
      <div class="badge-label">Content Pipeline</div>
      <div class="badge-value"><span id="stagingCountHeader">‚Äî</span> in staging</div>
      <div class="badge-sub"><span id="postedCountHeader">‚Äî</span> videos posted</div>
    </div>
  </header>

  <div class="main-content">

    <!-- METRICS ROW -->
    <div class="section-title">Live Metrics</div>
    <div class="metrics-grid">
      <div class="metric-card highlight">
        <div class="metric-label">Videos in Staging</div>
        <div class="metric-value accent" id="stagingCount">‚Äî</div>
        <div class="metric-sub">Folder 08 ¬∑ Ready to post</div>
        <button class="refresh-btn" id="refreshBtn" onclick="refreshMetrics()" style="margin-top:10px;font-size:0.7rem;padding:5px 12px">‚Üª Refresh</button>
      </div>
      <div class="metric-card">
        <div class="metric-label">Videos Posted</div>
        <div class="metric-value" id="postedCount">‚Äî</div>
        <div class="metric-sub">Folder 03 ¬∑ Live content</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">YouTube Subscribers</div>
        <div class="metric-value gold" id="ytSubs">‚Äî</div>
        <div class="metric-sub" id="ytViews">‚Äî total views</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Facebook Followers</div>
        <div class="metric-value" id="fbFollowers">‚Äî</div>
        <div class="metric-sub">ScriptureUnlocked</div>
        <div class="last-updated">Manual update needed</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Next Scheduled Post</div>
        <div class="metric-value" id="nextPost" style="font-size:1.3rem">‚Äî</div>
        <div class="metric-sub">Content calendar</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">App Status</div>
        <div class="metric-value" style="font-size:1.1rem;color:#fbbf24">Dev</div>
        <div class="metric-sub">scriptureunlocked.app</div>
        <div class="last-updated">In active development</div>
      </div>
    </div>

    <div class="last-updated" id="lastUpdated" style="margin-bottom:20px">Drive metrics: not yet loaded</div>

    <!-- STATUS CARDS -->
    <div class="section-title">Project Status</div>
    <div class="status-grid">
      <div class="status-card">
        <div class="status-header">
          <div class="status-name">üì± Scripture Unlocked App</div>
          <span class="status-pill dev">In Development</span>
        </div>
        <div class="status-desc">Mobile app for immersive scripture study. Active development phase.</div>
        <a href="https://scriptureunlocked.app" target="_blank" class="status-link">‚Üí scriptureunlocked.app</a>
      </div>
      <div class="status-card">
        <div class="status-header">
          <div class="status-name">‚ñ∂Ô∏è YouTube Channel</div>
          <span class="status-pill active">Active</span>
        </div>
        <div class="status-desc"><span id="ytSubs2">‚Äî</span> subscribers ¬∑ <span id="ytViews2">‚Äî</span> total views</div>
        <a href="https://youtube.com/channel/UCRWg7hCfbdeeQLaaPFEhNkw" target="_blank" class="status-link">‚Üí View Channel</a>
      </div>
      <div class="status-card">
        <div class="status-header">
          <div class="status-name">üìò Facebook Page</div>
          <span class="status-pill active">Active</span>
        </div>
        <div class="status-desc"><span id="fbFollowers2">‚Äî</span> followers</div>
        <a href="https://facebook.com/ScriptureUnlocked" target="_blank" class="status-link">‚Üí ScriptureUnlocked</a>
      </div>
    </div>

    <!-- STAGING FILES -->
    <div class="section-title">Staging Videos <span id="stagingCountLabel" style="color:#60a5fa;font-size:0.85rem;margin-left:8px;text-transform:none;letter-spacing:0;font-weight:800">‚Äî</span></div>
    <div class="files-card">
      <div class="file-list" id="stagingFiles">
        <div class="file-empty">Loading staging files‚Ä¶</div>
      </div>
    </div>

  </div>
</div>

<script>
const USERS = {
  'Grizzly123': 'mark',
  'STS-Vigen':  'vigen',
  'STS-Arno':   'arno',
  'STS-Team':   'team',
};

function checkPw() {
  const v = document.getElementById('pwInput').value.trim();
  if (USERS[v]) {
    localStorage.setItem('su_auth', v);
    launch();
  } else {
    document.getElementById('pwError').style.display = 'block';
  }
}

function launch() {
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  refreshMetrics();
  loadStoredMetrics();
}

function autoLogin() {
  const saved = localStorage.getItem('su_auth');
  if (saved && USERS[saved]) { launch(); return true; }
  return false;
}

if (!autoLogin()) { /* show password screen */ }

function loadStoredMetrics() {
  const cached = localStorage.getItem('su_metrics');
  if (cached) {
    try { applyMetrics(JSON.parse(cached)); } catch(e) {}
  }
}

/* SUPABASE DIRECT */
const SB_URL = 'https://cmdcitqfrzfmeghrvily.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZGNpdHFmcnpmbWVnaHJ2aWx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTgwMDIsImV4cCI6MjA4NTk3NDAwMn0.wrx599rkgJeSTa4N15DRSn4Tp1_3vrtwx2XF7HEviMo';
const SB_H = { 'Content-Type': 'application/json', apikey: SB_KEY, Authorization: 'Bearer ' + SB_KEY };

async function refreshMetrics() {
  const btn = document.getElementById('refreshBtn');
  if (btn) { btn.disabled = true; btn.textContent = '‚Üª Loading‚Ä¶'; }
  try {
    const r = await fetch(
      `${SB_URL}/rest/v1/agent_tasks?to_agent=eq.su_metrics&status=eq.active&order=created_at.desc&limit=50`,
      { headers: SB_H }
    );
    const rows = await r.json();
    if (Array.isArray(rows) && rows.length > 0) {
      const d = {};
      for (const row of rows) {
        try { d[row.task] = JSON.parse(row.context || '{}'); } catch(e) {}
      }
      const merged = mergeMetrics(d);
      localStorage.setItem('su_metrics', JSON.stringify(merged));
      applyMetrics(merged);
    } else {
      showFallback('No metrics stored yet ‚Äî run update-cc-metrics.mjs');
    }
  } catch(e) {
    showFallback('Could not reach Supabase: ' + e.message);
  }
  if (btn) { btn.disabled = false; btn.textContent = '‚Üª Refresh'; }
}

function mergeMetrics(d) {
  const out = {};
  if (d.drive) {
    out.stagingCount = d.drive.stagingCount;
    out.postedCount = d.drive.postedCount;
    out.stagingFiles = d.drive.stagingFiles || [];
    out.fetchedAt = d.drive.fetchedAt;
  }
  if (d.youtube) {
    out.ytSubscribers = d.youtube.subscribers;
    out.ytViews = d.youtube.views;
  }
  if (d.social) {
    out.fbFollowers = d.social.fbFollowers;
  }
  return out;
}

function applyMetrics(d) {
  setText('stagingCount', d.stagingCount ?? '‚Äî');
  setText('postedCount', d.postedCount ?? '‚Äî');
  setText('stagingCountHeader', d.stagingCount ?? '‚Äî');
  setText('postedCountHeader', d.postedCount ?? '‚Äî');
  setText('stagingCountLabel', d.stagingCount != null ? `(${d.stagingCount} videos)` : '');

  if (d.ytSubscribers != null) {
    const subs = fmtNum(d.ytSubscribers);
    const views = fmtNum(d.ytViews);
    setText('ytSubs', subs);
    setText('ytViews', views + ' total views');
    setText('ytSubs2', subs + ' subscribers');
    setText('ytViews2', views);
  }

  if (d.stagingFiles && d.stagingFiles.length > 0) {
    document.getElementById('stagingFiles').innerHTML = d.stagingFiles.map(n =>
      `<div class="file-item"><span class="file-icon">üé¨</span><span class="file-name">${esc(n)}</span></div>`
    ).join('');
  } else {
    document.getElementById('stagingFiles').innerHTML = '<div class="file-empty">No videos in staging</div>';
  }

  if (d.fetchedAt) {
    const ts = new Date(d.fetchedAt).toLocaleString('en-US', {month:'short', day:'numeric', hour:'numeric', minute:'2-digit'});
    setText('lastUpdated', `Drive metrics last updated: ${ts}`);
  }
}

function showFallback(msg) {
  setText('lastUpdated', msg || 'Could not load metrics ‚Äî run update-cc-metrics.mjs');
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function fmtNum(n) {
  if (!n && n !== 0) return '‚Äî';
  if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'K';
  return n.toLocaleString();
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
