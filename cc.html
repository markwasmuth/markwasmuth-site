<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Brands Mission Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0f172a;
            background-image: linear-gradient(135deg, #1e1b4b 0%, #1e3a5f 50%, #312e81 100%);
            background-attachment: fixed;
            color: #f1f5f9;
            min-height: 100vh;
            position: relative;
        }
        
        /* Circuit Board Background */
        #circuitCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none !important;
        }
        
        #passwordScreen, #dashboard, .modal {
            position: relative;
            z-index: 2;
        }
        
        /* Animated pulse glow on header */
        @keyframes headerPulse {
            0%, 100% { text-shadow: 0 0 20px rgba(59, 130, 246, 0.4), 0 0 40px rgba(59, 130, 246, 0.15); }
            50% { text-shadow: 0 0 30px rgba(99, 102, 241, 0.7), 0 0 60px rgba(59, 130, 246, 0.3), 0 0 80px rgba(129, 140, 248, 0.15); }
        }

        @keyframes borderGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.08); }
            50% { box-shadow: 0 0 25px rgba(59, 130, 246, 0.15), 0 0 50px rgba(129, 140, 248, 0.06); }
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        
        /* Password Screen */
        #passwordScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: transparent;
        }
        
        .password-box {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 16px;
            padding: 44px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.04);
        }

        .password-box h1 {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 8px;
            color: #93c5fd;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: headerPulse 4s ease-in-out infinite;
        }

        .password-box p {
            color: #64748b;
            margin-bottom: 28px;
            font-size: 14px;
            letter-spacing: 1px;
        }

        .password-box input {
            width: 100%;
            padding: 12px 16px;
            font-size: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.8);
            color: #f1f5f9;
            margin-bottom: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .password-box input:focus {
            border-color: rgba(59, 130, 246, 0.5);
        }

        .password-box button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            letter-spacing: 0.5px;
        }

        .password-box button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .password-error {
            color: #f87171;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        /* Dashboard */
        #dashboard {
            display: none;
            padding: 20px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }
        
        .header h1 {
            font-size: 56px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -1px;
            color: #00d9ff;
            animation: headerPulse 4s ease-in-out infinite;
        }
        
        .header .subtitle {
            color: #8899aa;
            font-size: 26px;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        /* Grid Layout - ARK Style */
        .ventures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
        }
        
        @media (max-width: 1200px) {
            .ventures-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .ventures-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Venture Box */
        .venture-box {
            background: rgba(17, 24, 39, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2d5a8a;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            animation: borderGlow 6s ease-in-out infinite;
        }
        
        .venture-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--brand-color);
            opacity: 0.9;
            box-shadow: 0 0 12px var(--brand-color);
        }
        
        .venture-box::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0.08;
            background-image:
                linear-gradient(90deg, var(--brand-color) 1px, transparent 1px),
                linear-gradient(0deg, var(--brand-color) 1px, transparent 1px),
                radial-gradient(circle 3px, var(--brand-color) 2px, transparent 2px);
            background-size: 25px 25px, 25px 25px, 25px 25px;
            background-position: 0 0, 0 0, 12.5px 12.5px;
            mask-image: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 50%, transparent 80%);
            -webkit-mask-image: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 50%, transparent 80%);
        }
        
        .venture-box:hover {
            border-color: var(--brand-color);
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2), 0 0 40px rgba(168, 85, 247, 0.15), 0 8px 30px rgba(0, 0, 0, 0.4), inset 0 0 30px rgba(0, 217, 255, 0.03);
        }
        
        .venture-box:hover::after {
            opacity: 0.15;
        }
        
        .venture-name {
            font-size: 38px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--brand-color);
        }
        
        .venture-tagline {
            font-size: 24px;
            color: #6b7d93;
            margin-bottom: 15px;
        }
        
        .venture-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat {
            text-align: left;
        }
        
        .stat-label {
            font-size: 22px;
            color: #5a6b7d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 34px;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        /* Center Command Box */
        .command-center {
            background: linear-gradient(135deg, rgba(13, 26, 42, 0.9) 0%, rgba(17, 24, 39, 0.9) 50%, rgba(13, 21, 37, 0.9) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid #00d9ff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-top: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            animation: borderGlow 4s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        
        .command-center::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00d9ff, #a855f7, #00d9ff, #a855f7);
            background-size: 400% 400%;
            border-radius: 13px;
            z-index: -1;
            opacity: 0.15;
            animation: gradientShift 8s ease infinite;
            pointer-events: none;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .command-center h2 {
            font-size: 44px;
            margin-bottom: 20px;
            color: #00d9ff;
            text-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }
        
        .command-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .command-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .command-stat {
            padding: 15px;
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 10px;
        }
        
        .command-stat-value {
            font-size: 48px;
            font-weight: 700;
            color: #00d9ff;
            margin-bottom: 6px;
        }
        
        .command-stat-label {
            font-size: 24px;
            color: #8899aa;
        }
        
        .command-stat.clickable {
            cursor: pointer;
        }
        
        .command-stat.clickable:hover {
            background: rgba(0, 217, 255, 0.12);
            border-color: rgba(0, 217, 255, 0.5);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.15);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: rgba(17, 24, 39, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            max-width: 900px;
            margin: 40px auto;
            border-radius: 12px;
            padding: 40px;
            position: relative;
            border: 1px solid #2d5a8a;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 44px;
            font-weight: 300;
            color: #5a6b7d;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #60a5fa;
        }

        .modal h2 {
            font-size: 48px;
            margin-bottom: 10px;
            color: #60a5fa;
        }
        
        .modal .subtitle {
            color: #8899aa;
            font-size: 26px;
            margin-bottom: 30px;
        }
        
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .agent-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .agent-card {
            background: #0d1525;
            border: 1px solid #2d5a8a;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agent-name {
            font-size: 34px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #60a5fa;
        }
        
        .agent-role {
            font-size: 26px;
            color: #8899aa;
            margin-bottom: 10px;
        }
        
        .agent-duty {
            font-size: 24px;
            color: #99aabb;
            line-height: 1.5;
        }
        
        .agent-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
        }
        
        /* Agent Detail Modal */
        .detail-section {
            margin-bottom: 30px;
        }
        
        .detail-section h3 {
            font-size: 32px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(59,130,246,0.2);
        }
        
        .detail-task {
            background: #0d1525;
            border: 1px solid #2d5a8a;
            border-radius: 8px;
            padding: 16px 18px;
            margin-bottom: 10px;
        }
        
        .detail-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .detail-task-from {
            font-size: 24px;
            color: #8899aa;
        }
        
        .detail-task-body {
            font-size: 26px;
            color: #c0d0e0;
            line-height: 1.5;
        }
        
        .collab-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .collab-chip {
            padding: 10px 18px;
            background: #1a2740;
            border: 1px solid #2d5a8a;
            border-radius: 20px;
            font-size: 26px;
            font-weight: 600;
            color: #c0d0e0;
        }
        
        .collab-chip.external {
            background: #2a1f00;
            border-color: #6b5000;
            color: #ffc107;
        }
        
        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .asset-item {
            padding: 12px 16px;
            background: #0d1a2a;
            border: 1px solid #2d5a8a;
            border-radius: 8px;
            font-size: 26px;
            color: #88bbdd;
        }
        
        .progress-bar-container {
            background: #1a2740;
            border-radius: 8px;
            height: 10px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 22px;
            color: #8899aa;
            margin-top: 4px;
        }
        
        .empty-state {
            text-align: center;
            color: #888;
            padding: 20px;
            font-size: 22px;
        }
        
        /* Venture Detail */
        .venture-member {
            background: #0d1525;
            border: 1px solid #2d5a8a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .venture-member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .venture-member-name {
            font-size: 32px;
            font-weight: 700;
            color: #e0e0e0;
        }
        
        .venture-member-role {
            font-size: 22px;
            color: #5a6b7d;
            font-weight: 600;
        }
        
        .venture-member-tasks {
            margin-top: 10px;
        }
        
        .venture-task {
            padding: 10px 14px;
            background: #111827;
            border: 1px solid #1a2740;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 24px;
            color: #99aabb;
            line-height: 1.5;
        }
        
        .venture-task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 22px;
            color: #5a6b7d;
        }
        
        /* Chat System */
        .chat-container {
            display: flex;
            height: 75vh;
            gap: 0;
        }
        
        .chat-sidebar {
            width: 240px;
            background: #0d1525;
            border-right: 1px solid #2d5a8a;
            border-radius: 10px 0 0 10px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .chat-sidebar-title {
            padding: 16px;
            font-size: 22px;
            font-weight: 700;
            color: #5a6b7d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #2d5a8a;
        }
        
        .chat-room {
            padding: 14px 16px;
            cursor: pointer;
            border-bottom: 1px solid #162030;
            transition: background 0.2s;
        }
        
        .chat-room:hover {
            background: #1a2740;
        }
        
        .chat-room.active {
            background: rgba(59, 130, 246, 0.25);
            color: #93c5fd;
        }
        
        .chat-room-name {
            font-size: 24px;
            font-weight: 600;
        }
        
        .chat-room-desc {
            font-size: 20px;
            color: #5a6b7d;
            margin-top: 2px;
        }
        
        .chat-room.active .chat-room-desc {
            color: rgba(255,255,255,0.7);
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #111827;
            border-radius: 0 10px 10px 0;
        }
        
        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #2d5a8a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header-name {
            font-size: 32px;
            font-weight: 700;
        }
        
        .chat-header-status {
            font-size: 22px;
            color: #5a6b7d;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .chat-msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 24px;
            line-height: 1.5;
        }
        
        .chat-msg.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
            border-bottom-right-radius: 4px;
        }
        
        .chat-msg.agent {
            align-self: flex-start;
            background: #1a2740;
            color: #c0d0e0;
            border-bottom-left-radius: 4px;
        }
        
        .chat-msg-sender {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #60a5fa;
        }
        
        .chat-msg.user .chat-msg-sender {
            color: rgba(10,14,26,0.7);
        }
        
        .chat-msg-text {
            white-space: pre-wrap;
        }
        
        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid #2d5a8a;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 24px;
            border: 1px solid #2d5a8a;
            background: #0a0e1a;
            color: #e0e0e0;
            border-radius: 10px;
            outline: none;
            font-family: inherit;
        }
        
        .chat-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
        }

        .chat-send {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chat-send:hover {
            opacity: 0.88;
        }
        
        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .chat-typing {
            align-self: flex-start;
            padding: 10px 16px;
            background: #1a2740;
            border-radius: 12px;
            font-size: 22px;
            color: #888;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .chat-sidebar {
                width: 180px;
            }
        }
        
        /* Task Management */
        .task-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .task-controls select, .task-controls button {
            padding: 10px 16px;
            font-size: 22px;
            border: 1px solid #2d5a8a;
            border-radius: 8px;
            background: #0d1525;
            color: #c0d0e0;
            cursor: pointer;
        }
        
        .task-controls button {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
            border: none;
            font-weight: 600;
        }

        .task-controls button:hover {
            opacity: 0.88;
        }
        
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .task-item {
            background: #0d1525;
            border: 1px solid #2d5a8a;
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .task-item.priority-high {
            border-left: 4px solid #e53e3e;
        }
        
        .task-item.priority-medium {
            border-left: 4px solid #dd6b20;
        }
        
        .task-item.priority-urgent {
            border-left: 4px solid #ff0000;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-agents {
            font-size: 24px;
            color: #8899aa;
        }
        
        .task-agents strong {
            color: #333;
        }
        
        .task-body {
            font-size: 26px;
            color: #c0d0e0;
            line-height: 1.5;
        }
        
        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }
        
        .task-meta {
            font-size: 20px;
            color: #888;
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
        }
        
        .task-actions button {
            padding: 6px 14px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-start {
            background: #3182ce;
            color: #fff;
        }
        
        .btn-start:hover {
            background: #2b6cb0;
        }
        
        .btn-done {
            background: #38a169;
            color: #fff;
        }
        
        .btn-done:hover {
            background: #2f855a;
        }
        
        .btn-delete {
            background: #e53e3e;
            color: #fff;
        }
        
        .btn-delete:hover {
            background: #c53030;
        }
        
        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fefcbf;
            color: #975a16;
        }
        
        .status-in_progress {
            background: #bee3f8;
            color: #2a4365;
        }
        
        .status-done {
            background: #c6f6d5;
            color: #22543d;
        }
        
        /* New Task Form */
        .new-task-form {
            display: none;
            background: #0d1525;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .new-task-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .form-row select, .form-row input {
            flex: 1;
            padding: 10px;
            font-size: 22px;
            border: 1px solid #2d5a8a;
            border-radius: 8px;
            background: #0a0e1a;
            color: #c0d0e0;
        }
        
        .form-row textarea {
            width: 100%;
            padding: 10px;
            font-size: 22px;
            border: 1px solid #2d5a8a;
            background: #0a0e1a;
            color: #c0d0e0;
            border-radius: 8px;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-actions button {
            padding: 10px 20px;
            font-size: 22px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
        }
        
        .btn-cancel {
            background: #2d5a8a;
            color: #c0d0e0;
        }
        
        /* Council Feed */
        .feed-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #2d5a8a;
        }
        
        .feed-tab {
            padding: 10px 20px;
            font-size: 22px;
            font-weight: 600;
            color: #5a6b7d;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .feed-tab.active {
            color: #60a5fa;
            border-bottom-color: #3b82f6;
        }
        
        .feed-tab:hover {
            color: #c0d0e0;
        }
        
        .feed-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .feed-item {
            background: #0d1525;
            border: 1px solid #2d5a8a;
            border-radius: 10px;
            padding: 16px 20px;
        }
        
        .feed-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .feed-agent {
            font-weight: 700;
            font-size: 28px;
            color: #e0e0e0;
        }
        
        .feed-time {
            font-size: 20px;
            color: #888;
        }
        
        .feed-body {
            font-size: 26px;
            color: #99aabb;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .feed-direction {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .feed-direction.incoming {
            background: #bee3f8;
            color: #2a4365;
        }
        
        .feed-direction.outgoing {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .council-agent-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .agent-chip {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 22px;
            font-weight: 600;
            background: #1a2740;
            color: #8899aa;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agent-chip.active {
            background: rgba(59, 130, 246, 0.3);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .agent-chip:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .agent-chip.active:hover {
            background: rgba(59, 130, 246, 0.35);
        }

        /* ===== LAYOUT SYSTEM ===== */
        #dashboard {
            display: none;
            padding: 0;
            max-width: 100%;
            margin: 0;
        }

        /* Full-width header bar */
        .top-header {
            width: 100%;
            padding: 12px 24px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            display: flex;
            align-items: center;
            gap: 18px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-header h1 {
            font-size: 16px;
            font-weight: 800;
            color: #93c5fd;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.15);
            animation: headerPulse 4s ease-in-out infinite;
            white-space: nowrap;
        }

        .top-header .header-tagline {
            font-size: 12px;
            color: rgba(148, 163, 184, 0.5);
            letter-spacing: 2px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .top-header .header-right {
            margin-left: auto;
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 12px;
            color: #475569;
        }

        .header-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-stat-val {
            color: #60a5fa;
            font-weight: 700;
            font-size: 13px;
        }

        /* Dashboard content layout */
        .dashboard-layout {
            display: flex;
            min-height: calc(100vh - 52px);
            gap: 0;
            position: relative;
        }

        /* ===== MAIN SIDEBAR (replaces icon-strip) ===== */
        .sidebar {
            width: 240px;
            min-width: 240px;
            background: rgba(10, 17, 32, 0.88);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-right: 1px solid rgba(59, 130, 246, 0.1);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 48px;
            height: calc(100vh - 48px);
            z-index: 50;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar::-webkit-scrollbar {
            width: 3px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.2);
            border-radius: 3px;
        }

        .sidebar-brand {
            padding: 20px 16px 14px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.08);
            flex-shrink: 0;
        }

        .sidebar-brand-name {
            font-size: 12px;
            font-weight: 800;
            color: #60a5fa;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
        }

        .sidebar-brand-sub {
            font-size: 11px;
            color: rgba(148, 163, 184, 0.45);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-top: 3px;
        }

        .sidebar-section {
            padding: 14px 12px 4px;
        }

        .sidebar-section-label {
            font-size: 10px;
            font-weight: 700;
            color: #334155;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 6px;
            padding: 0 6px;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 8px 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.18s;
            margin-bottom: 1px;
            border: 1px solid transparent;
            position: relative;
        }

        .sidebar-nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.12);
        }

        .sidebar-nav-item.active {
            background: rgba(59, 130, 246, 0.14);
            border-color: rgba(59, 130, 246, 0.22);
        }

        .sidebar-nav-icon {
            font-size: 14px;
            width: 26px;
            text-align: center;
            flex-shrink: 0;
            line-height: 1;
        }

        .sidebar-nav-text {
            font-size: 13px;
            font-weight: 500;
            color: #94a3b8;
            transition: color 0.18s;
            white-space: nowrap;
        }

        .sidebar-nav-item:hover .sidebar-nav-text {
            color: #e2e8f0;
        }

        .sidebar-nav-item.active .sidebar-nav-text {
            color: #93c5fd;
            font-weight: 600;
        }

        .sidebar-notif {
            width: 7px;
            height: 7px;
            background: #f87171;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(248, 113, 113, 0.7);
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }

        .sidebar-separator {
            border: none;
            border-top: 1px solid rgba(59, 130, 246, 0.07);
            margin: 6px 14px;
        }

        /* Legacy icon-strip notif-dot (kept for JS compatibility) */
        .notif-dot {
            width: 7px;
            height: 7px;
            background: #f87171;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(248, 113, 113, 0.7);
        }

        /* ===== SIDEBAR PANEL (slide-in panels) ===== */
        .sidebar-panel {
            width: 0;
            overflow: hidden;
            background: rgba(10, 17, 32, 0.92);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid rgba(59, 130, 246, 0.08);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: sticky;
            top: 48px;
            height: calc(100vh - 48px);
            z-index: 40;
        }

        .sidebar-panel.open {
            width: 300px;
        }

        .sidebar-panel-content {
            display: none;
            width: 300px;
            height: 100%;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .sidebar-panel-content.active {
            display: block;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            letter-spacing: 0.5px;
        }

        /* Sidebar agent list */
        .sidebar-agents {
            overflow-y: auto;
            max-height: calc(100vh - 160px);
        }

        .sidebar-agent {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 2px solid transparent;
            border-radius: 0 8px 8px 0;
            margin-bottom: 2px;
        }

        .sidebar-agent:hover {
            background: rgba(59, 130, 246, 0.08);
            border-left-color: #3b82f6;
        }

        .agent-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ea05a;
            flex-shrink: 0;
            box-shadow: 0 0 6px rgba(46, 160, 90, 0.6);
            animation: dotPulse 2s infinite;
        }

        @keyframes dotPulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 6px rgba(46, 160, 90, 0.6); }
            50% { opacity: 0.6; box-shadow: 0 0 14px rgba(46, 160, 90, 0.9); }
        }

        .sidebar-agent-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-agent-name {
            font-size: 14px;
            font-weight: 600;
            color: #c9d1d9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-agent-role {
            font-size: 12px;
            color: #4a5a6a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Sidebar task feed */
        .sidebar-tasks {
            overflow-y: auto;
            max-height: calc(100vh - 160px);
        }

        .sidebar-task-item {
            padding: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.06);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .sidebar-task-item:hover {
            background: rgba(59, 130, 246, 0.07);
        }

        .sidebar-task-agents {
            font-size: 13px;
            color: #60a5fa;
            margin-bottom: 4px;
        }

        .sidebar-task-text {
            font-size: 13px;
            color: #8899aa;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .sidebar-task-priority {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .priority-urgent { background: rgba(255, 68, 68, 0.15); color: #ff4444; }
        .priority-high { background: rgba(210, 153, 34, 0.15); color: #d29922; }
        .priority-medium { background: rgba(56, 139, 253, 0.15); color: #388bfd; }
        .priority-low { background: rgba(85, 85, 85, 0.15); color: #666; }

        .sidebar-empty {
            padding: 20px;
            font-size: 14px;
            color: #4a5a6a;
            text-align: center;
        }

        /* Sidebar action items (inside panels) */
        .sb-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
            margin-bottom: 6px;
            border: 1px solid transparent;
        }

        .sb-action:hover {
            background: rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.15);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.06);
        }

        .sb-action .sb-icon {
            font-size: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.12);
            border-radius: 8px;
            flex-shrink: 0;
        }

        .sb-action .sb-label {
            font-size: 14px;
            font-weight: 600;
            color: #c9d1d9;
        }

        .sb-action .sb-desc {
            font-size: 12px;
            color: #4a5a6a;
            margin-top: 1px;
        }

        .sb-divider {
            border-top: 1px solid rgba(59, 130, 246, 0.07);
            margin: 10px 0;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            max-height: calc(100vh - 52px);
        }

        .main-content .header {
            display: none; /* moved to top-header */
        }

        /* Updated venture boxes â€” hidden in overview (in sidebar now) */
        .ventures-grid {
            display: none !important;
        }

        .venture-box {
            background: rgba(255, 255, 255, 0.05) !important;
            backdrop-filter: blur(16px) !important;
            -webkit-backdrop-filter: blur(16px) !important;
            border: 1px solid rgba(255, 255, 255, 0.07) !important;
        }

        .venture-box:hover {
            background: rgba(255, 255, 255, 0.08) !important;
            border-color: var(--brand-color) !important;
        }

        /* ===== METRIC CARDS ROW (replaces command center) ===== */
        .metric-cards-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 1100px) {
            .metric-cards-row { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 700px) {
            .metric-cards-row { grid-template-columns: repeat(2, 1fr); }
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .metric-card:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .metric-card-label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
        }

        .metric-card-value {
            font-size: 28px;
            font-weight: 700;
            color: #e2e8f0;
            line-height: 1;
            margin-bottom: 4px;
        }

        .metric-card-sub {
            font-size: 11px;
            color: #475569;
        }

        /* Keep .command-center for JS compatibility but hide it */
        .command-center {
            display: none !important;
        }

        /* Legacy command-stat (kept for JS ID compatibility, elements moved into metric cards) */
        .command-stat {
            display: none;
        }

        /* Glass modals */
        .modal-content {
            background: rgba(15, 23, 42, 0.9) !important;
            backdrop-filter: blur(28px) !important;
            -webkit-backdrop-filter: blur(28px) !important;
            border: 1px solid rgba(59, 130, 246, 0.15) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
        }

        /* Override old grid styles */
        .ventures-grid {
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* ===== OVERVIEW PANEL (two-column content area) ===== */
        .overview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .overview-grid { grid-template-columns: 1fr; }
        }

        .overview-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 12px;
            padding: 18px 20px;
        }

        .overview-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .overview-card-title {
            font-size: 13px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .overview-card-action {
            font-size: 12px;
            color: #3b82f6;
            cursor: pointer;
            transition: color 0.15s;
        }

        .overview-card-action:hover {
            color: #60a5fa;
        }

        /* Quick-task feed items in main content */
        .qt-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .qt-item:last-child {
            border-bottom: none;
        }

        .qt-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .qt-dot.pending { background: #f59e0b; }
        .qt-dot.in_progress { background: #3b82f6; box-shadow: 0 0 6px rgba(59,130,246,0.5); }
        .qt-dot.done { background: #10b981; }

        .qt-body {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.45;
            flex: 1;
        }

        .qt-meta {
            font-size: 11px;
            color: #475569;
            margin-top: 3px;
        }

        /* Agent quick-list in overview */
        .agent-ql-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            cursor: pointer;
            transition: background 0.15s;
            border-radius: 6px;
            padding-left: 4px;
        }

        .agent-ql-item:last-child {
            border-bottom: none;
        }

        .agent-ql-item:hover {
            background: rgba(59,130,246,0.06);
        }

        .agent-ql-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 6px rgba(16,185,129,0.5);
            flex-shrink: 0;
        }

        .agent-ql-name {
            font-size: 13px;
            font-weight: 600;
            color: #cbd5e1;
        }

        .agent-ql-role {
            font-size: 11px;
            color: #475569;
            margin-left: auto;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1100px) {
            .sidebar-panel.open { width: 260px; }
            .sidebar-panel-content { width: 260px; }
            .sidebar { width: 200px; min-width: 200px; }
        }

        @media (max-width: 768px) {
            .top-header { padding: 10px 16px; gap: 10px; }
            .top-header h1 { font-size: 14px; letter-spacing: 2px; }
            .top-header .header-tagline { display: none; }
            .top-header .header-right { display: none; }
            .dashboard-layout { flex-direction: column; }
            .sidebar {
                width: 100%; min-width: 100%; height: auto;
                flex-direction: row; position: relative; top: 0;
                overflow-x: auto; overflow-y: hidden;
                flex-wrap: wrap; padding: 8px 12px;
            }
            .sidebar-brand { display: none; }
            .sidebar-separator { display: none; }
            .sidebar-section { padding: 4px 4px; }
            .sidebar-section-label { display: none; }
            .sidebar-nav-item { padding: 6px 8px; }
            .sidebar-panel {
                width: 100% !important; height: auto;
                position: relative; top: 0;
            }
            .sidebar-panel.open { width: 100% !important; }
            .sidebar-panel-content { width: 100% !important; height: auto; max-height: 50vh; }
            .main-content { max-height: none; }
        }

    </style>
</head>
<body>
    <canvas id="circuitCanvas"></canvas>
    <!-- Password Screen -->
    <div id="passwordScreen">
        <div class="password-box">
            <h1>Smart Brands Mission Control</h1>
            <p>Enter password to access dashboard</p>
            <input type="password" id="passwordInput" placeholder="Password" />
            <button onclick="checkPassword()">Access Dashboard</button>
            <div class="password-error" id="passwordError">Incorrect password</div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <!-- Full-width header -->
        <div class="top-header">
            <h1>SMART BRANDS INC</h1>
            <div class="header-tagline">Mission Control</div>
            <div class="header-right">
                <div class="header-stat">Ventures <span class="header-stat-val">6</span></div>
                <div class="header-stat">Agents <span class="header-stat-val">13</span></div>
            </div>
        </div>

        <div class="dashboard-layout">

        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <div class="sidebar-brand-name">âš¡ Smart Brands</div>
                <div class="sidebar-brand-sub">Mission Control</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-label">Command Center</div>
                <div class="sidebar-nav-item active" onclick="setSidebarActive(this)">
                    <span class="sidebar-nav-icon">ðŸ“Š</span>
                    <span class="sidebar-nav-text">Overview</span>
                </div>
                <div class="sidebar-nav-item" onclick="setSidebarActive(this); toggleSidebarPanel('chat')">
                    <span class="sidebar-nav-icon">ðŸ’¬</span>
                    <span class="sidebar-nav-text">Chat</span>
                </div>
                <div class="sidebar-nav-item" onclick="setSidebarActive(this); toggleSidebarPanel('tasks')">
                    <span class="sidebar-nav-icon">ðŸ“‹</span>
                    <span class="sidebar-nav-text">Tasks</span>
                </div>
                <div class="sidebar-nav-item" onclick="setSidebarActive(this); toggleSidebarPanel('review')" id="sidebar-review-btn">
                    <span class="sidebar-nav-icon">ðŸ“</span>
                    <span class="sidebar-nav-text">Review Queue</span>
                    <span class="sidebar-notif" id="review-notif-dot"></span>
                </div>
                <div class="sidebar-nav-item" onclick="setSidebarActive(this); toggleSidebarPanel('links')">
                    <span class="sidebar-nav-icon">âš¡</span>
                    <span class="sidebar-nav-text">Quick Links</span>
                </div>
            </div>

            <hr class="sidebar-separator">

            <div class="sidebar-section">
                <div class="sidebar-section-label">Ventures</div>
                <div class="sidebar-nav-item" onclick="openVenture('snaptosell')">
                    <span class="sidebar-nav-icon">ðŸ”·</span>
                    <span class="sidebar-nav-text">SnapToSell</span>
                </div>
                <div class="sidebar-nav-item" onclick="openVenture('book')">
                    <span class="sidebar-nav-icon">ðŸ“•</span>
                    <span class="sidebar-nav-text">The Enemy Within</span>
                </div>
                <div class="sidebar-nav-item" onclick="openVenture('scripture')">
                    <span class="sidebar-nav-icon">âœï¸</span>
                    <span class="sidebar-nav-text">Scripture Unlocked</span>
                </div>
                <div class="sidebar-nav-item" onclick="openVenture('farm')">
                    <span class="sidebar-nav-icon">ðŸŽ</span>
                    <span class="sidebar-nav-text">Farm Flow</span>
                </div>
                <div class="sidebar-nav-item" onclick="openVenture('aeromind')">
                    <span class="sidebar-nav-icon">âœˆï¸</span>
                    <span class="sidebar-nav-text">AeroMind Ops</span>
                </div>
                <div class="sidebar-nav-item" onclick="openVenture('coaching')">
                    <span class="sidebar-nav-icon">ðŸ™</span>
                    <span class="sidebar-nav-text">BE DO HAVE</span>
                </div>
            </div>

            <hr class="sidebar-separator">

            <div class="sidebar-section">
                <div class="sidebar-section-label">Council</div>
                <div class="sidebar-nav-item" onclick="showAgents()">
                    <span class="sidebar-nav-icon">ðŸ‘¥</span>
                    <span class="sidebar-nav-text">All 13 Agents</span>
                </div>
                <div class="sidebar-nav-item" onclick="showCouncilTasks()">
                    <span class="sidebar-nav-icon">ðŸ“Š</span>
                    <span class="sidebar-nav-text">Council Tasks</span>
                </div>
                <div class="sidebar-nav-item" onclick="showMarkTasks()">
                    <span class="sidebar-nav-icon">âœ…</span>
                    <span class="sidebar-nav-text">Mark's Tasks</span>
                </div>
                <div class="sidebar-nav-item" onclick="setSidebarActive(this); showSnapTasks()">
                    <span class="sidebar-nav-icon">ðŸ”·</span>
                    <span class="sidebar-nav-text">SnapToSell Tasks</span>
                </div>
            </div>
        </div>

        <!-- Expandable sidebar panel -->
        <div class="sidebar-panel" id="sidebarPanel">

            <!-- Chat panel -->
            <div class="sidebar-panel-content" id="panel-chat">
                <div class="panel-title">ðŸ’¬ Chat</div>
                <div class="sb-action" onclick="showChat()">
                    <div class="sb-icon">ðŸŒ</div>
                    <div><div class="sb-label">All Hands</div><div class="sb-desc">Full Council room</div></div>
                </div>
                <div class="sb-divider"></div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('madison','individual'),100)">
                    <div class="sb-icon">ðŸ“š</div>
                    <div><div class="sb-label">Madison Harper</div><div class="sb-desc">Book Marketing</div></div>
                </div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('cmo','individual'),100)">
                    <div class="sb-icon">ðŸ“ˆ</div>
                    <div><div class="sb-label">Alexis Monroe</div><div class="sb-desc">CMO</div></div>
                </div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('cto','individual'),100)">
                    <div class="sb-icon">ðŸ”§</div>
                    <div><div class="sb-label">Marcus Steele</div><div class="sb-desc">CTO</div></div>
                </div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('ceo','individual'),100)">
                    <div class="sb-icon">ðŸ‘‘</div>
                    <div><div class="sb-label">CEO Advisor</div><div class="sb-desc">Strategy</div></div>
                </div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('cos','individual'),100)">
                    <div class="sb-icon">ðŸŽ¯</div>
                    <div><div class="sb-label">Chief of Staff</div><div class="sb-desc">Coordinator</div></div>
                </div>
                <div class="sb-divider"></div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('leadership','group'),100)">
                    <div class="sb-icon">ðŸ¢</div>
                    <div><div class="sb-label">Leadership</div><div class="sb-desc">CEO, COO, CFO, CRO</div></div>
                </div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('marketing-team','group'),100)">
                    <div class="sb-icon">ðŸ“£</div>
                    <div><div class="sb-label">Marketing Team</div><div class="sb-desc">Madison, Alexis, Media, Comms</div></div>
                </div>
                <div class="sb-action" onclick="showChat(); setTimeout(()=>openRoom('book-team','group'),100)">
                    <div class="sb-icon">ðŸ“–</div>
                    <div><div class="sb-label">Book Team</div><div class="sb-desc">Madison, Media, Comms, Intel</div></div>
                </div>
            </div>

            <!-- Council panel -->
            <div class="sidebar-panel-content" id="panel-council">
                <div class="panel-title">ðŸ‘¥ Council of 13</div>
                <div class="sidebar-agents" id="sidebar-agent-list">
                    <div class="sidebar-empty">Loading agents...</div>
                </div>
            </div>

            <!-- Tasks panel -->
            <div class="sidebar-panel-content" id="panel-tasks">
                <div class="panel-title">ðŸ“‹ Task Feed</div>
                <div class="sb-action" onclick="showCouncilTasks()" style="margin-bottom:12px;">
                    <div class="sb-icon">ðŸ¤–</div>
                    <div><div class="sb-label">Open Full Task Manager</div><div class="sb-desc">Create, assign & track</div></div>
                </div>
                <div class="sidebar-tasks" id="sidebar-task-feed">
                    <div class="sidebar-empty">Loading tasks...</div>
                </div>
            </div>

            <!-- Review panel -->
            <div class="sidebar-panel-content" id="panel-review">
                <div class="panel-title">ðŸ“ Review Queue</div>
                <div class="sb-action" onclick="showDeliverables()">
                    <div class="sb-icon">ðŸ“‹</div>
                    <div><div class="sb-label">Deliverables</div><div class="sb-desc">Allen's work pending review</div></div>
                </div>
                <div class="sb-action" onclick="showCouncilTasks()">
                    <div class="sb-icon">ðŸ¤–</div>
                    <div><div class="sb-label">Council Tasks</div><div class="sb-desc">AI agent work items</div></div>
                </div>
                <div class="sb-action" onclick="showMarkTasks()">
                    <div class="sb-icon">ðŸ‘¤</div>
                    <div><div class="sb-label">Mark's Tasks</div><div class="sb-desc">Your decision items</div></div>
                </div>
            </div>

            <!-- Quick Links panel -->
            <div class="sidebar-panel-content" id="panel-links">
                <div class="panel-title">âš¡ Quick Links</div>
                <div class="sb-action" onclick="showAgents()">
                    <div class="sb-icon">ðŸ›ï¸</div>
                    <div><div class="sb-label">Agent Directory</div><div class="sb-desc">View all 13 agents</div></div>
                </div>
                <div class="sb-action" onclick="showCouncilTasks()">
                    <div class="sb-icon">ðŸ“Š</div>
                    <div><div class="sb-label">Task Manager</div><div class="sb-desc">Full task dashboard</div></div>
                </div>
                <div class="sb-action" onclick="showMarkTasks()">
                    <div class="sb-icon">âœ…</div>
                    <div><div class="sb-label">Mark's Tasks</div><div class="sb-desc">Action items</div></div>
                </div>
                <div class="sb-action" onclick="showChat()">
                    <div class="sb-icon">ðŸ’¬</div>
                    <div><div class="sb-label">Council Chat</div><div class="sb-desc">Open chat rooms</div></div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">

        <!-- Hidden venture grid â€” preserves JS IDs for task count updates -->
        <div class="ventures-grid" style="display:none;">
            <div id="snaptosell-tasks"></div>
            <div id="book-tasks"></div>
            <div id="farm-tasks"></div>
            <div id="aeromind-tasks"></div>
            <div id="coaching-tasks"></div>
        </div>

        <!-- Compact Metric Cards Row -->
        <div class="metric-cards-row">
            <!-- Council Tasks -->
            <div class="metric-card" onclick="showCouncilTasks()">
                <div class="metric-card-label">ðŸ“‹ Council Tasks</div>
                <div class="metric-card-value" id="council-task-count">â€”</div>
                <div class="metric-card-sub">Click to manage</div>
            </div>
            <!-- Mark's Tasks -->
            <div class="metric-card" onclick="showMarkTasks()">
                <div class="metric-card-label">âœ… Mark's Tasks</div>
                <div class="metric-card-value" id="mark-task-count">â€”</div>
                <div class="metric-card-sub">Your action items</div>
            </div>
            <!-- Review Queue -->
            <div class="metric-card" onclick="showDeliverables()" style="position:relative;">
                <div class="metric-card-label">ðŸ“ Review Queue</div>
                <div class="metric-card-value" style="display:flex; align-items:center; gap:8px;">
                    <span id="deliverables-count" style="background:#f87171; color:#fff; font-size:16px; padding:2px 8px; border-radius:10px; font-weight:700; display:none;">0</span>
                    <span id="deliverables-count-display">â€”</span>
                </div>
                <div class="metric-card-sub">Pending review</div>
            </div>
            <!-- Agents -->
            <div class="metric-card" onclick="showAgents()">
                <div class="metric-card-label">ðŸ‘¥ Agents</div>
                <div class="metric-card-value">13</div>
                <div class="metric-card-sub">Council active</div>
            </div>
            <!-- API Cost -->
            <div class="metric-card" style="cursor:default;">
                <div class="metric-card-label">ðŸ’° API Today</div>
                <div class="metric-card-value" id="api-cost-display">â€”</div>
                <div class="metric-card-sub" id="api-calls-display">â€” calls</div>
            </div>
        </div>

        <!-- Overview Two-Column Grid -->
        <div class="overview-grid">
            <!-- Task Feed -->
            <div class="overview-card">
                <div class="overview-card-header">
                    <span class="overview-card-title">ðŸ“‹ Task Feed</span>
                    <span class="overview-card-action" onclick="showCouncilTasks()">View All â†’</span>
                </div>
                <div id="overview-task-feed">
                    <div style="font-size:13px; color:#475569; text-align:center; padding:20px 0;">Loading tasksâ€¦</div>
                </div>
            </div>
            <!-- Council Activity -->
            <div class="overview-card">
                <div class="overview-card-header">
                    <span class="overview-card-title">ðŸ‘¥ Council of 13</span>
                    <span class="overview-card-action" onclick="showAgents()">All Agents â†’</span>
                </div>
                <div id="overview-agent-list">
                    <div style="font-size:13px; color:#475569; text-align:center; padding:20px 0;">Loading agentsâ€¦</div>
                </div>
            </div>
        </div>

        <!-- API Usage Widget -->
        <div class="usage-widget" style="background: rgba(255,255,255,0.04); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.07); border-radius: 12px; padding: 18px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; font-size: 13px; font-weight:700; color: #60a5fa; text-transform:uppercase; letter-spacing:0.8px;">ðŸ“Š API Usage</h3>
                <div style="display: flex; gap: 4px;">
                    <button id="toggle-tokens" onclick="toggleUsageView('tokens')" style="padding: 4px 12px; border-radius: 6px; border: 1px solid rgba(59,130,246,0.3); background: rgba(59,130,246,0.15); color: #60a5fa; cursor: pointer; font-size: 12px; font-weight: 600;">Tokens</button>
                    <button id="toggle-dollars" onclick="toggleUsageView('dollars')" style="padding: 4px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); background: transparent; color: #64748b; cursor: pointer; font-size: 12px;">Dollars</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                <div style="text-align: center;">
                    <div id="usage-total" style="font-size: 20px; font-weight: 700; color: #60a5fa;">â€”</div>
                    <div style="font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing:0.5px;">Total</div>
                </div>
                <div style="text-align: center;">
                    <div id="usage-input" style="font-size: 20px; font-weight: 700; color: #4ade80;">â€”</div>
                    <div style="font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing:0.5px;">Input</div>
                </div>
                <div style="text-align: center;">
                    <div id="usage-output" style="font-size: 20px; font-weight: 700; color: #fb923c;">â€”</div>
                    <div style="font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing:0.5px;">Output</div>
                </div>
                <div style="text-align: center;">
                    <div id="usage-cache" style="font-size: 20px; font-weight: 700; color: #a78bfa;">â€”</div>
                    <div style="font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing:0.5px;">Cache Saved</div>
                </div>
                <div style="text-align: center;">
                    <div id="usage-calls" style="font-size: 20px; font-weight: 700; color: #fbbf24;">â€”</div>
                    <div style="font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing:0.5px;">API Calls</div>
                </div>
            </div>
            <div id="usage-daily" style="margin-top: 12px; display: flex; gap: 4px; align-items: flex-end; height: 50px;"></div>
            <div style="text-align: right; margin-top: 8px; font-size: 10px; color: #334155;" id="usage-updated">â€”</div>
        </div>

        <!-- Hidden legacy command center â€” keeps CSS class stable, hidden via CSS -->
        <div class="command-center" style="display:none;">
            <div class="command-stats">
                <div class="command-stat"><div id="council-task-count-legacy">â€”</div></div>
                <div class="command-stat"><div id="mark-task-count-legacy">â€”</div></div>
            </div>
        </div>

        </div><!-- end main-content -->
        </div><!-- end dashboard-layout -->
    </div>

    <!-- Council Agents Modal -->
    <div id="agentsModal" class="modal" onclick="if(event.target === this) closeAgents()">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAgents()">&times;</span>
            <h2>The Council</h2>
            <div class="subtitle">13 AI Agents Running Smart Brands Inc.</div>
            
            <div class="agent-grid">
                <div class="agent-card" onclick="openAgentDetail('madison')">
                    <div class="agent-name">Madison Harper</div>
                    <div class="agent-role">Book Marketing Director</div>
                    <div class="agent-duty">Owns The Enemy Within launch. Pre-launch strategy, ARC recruitment, social content, podcast tours, Amazon optimization. July 4, 2026 launch execution.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('cmo')">
                    <div class="agent-name">Alexis Monroe</div>
                    <div class="agent-role">CMO - Chief Marketing Officer</div>
                    <div class="agent-duty">Owns SnapToSell + Scripture Unlocked marketing. B2B SaaS strategy, YouTube growth, funnel design. Frameworks: Brunson, Abraham, Martell.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('cto')">
                    <div class="agent-name">Marcus Steele</div>
                    <div class="agent-role">CTO - Chief Technology Officer</div>
                    <div class="agent-duty">SnapToSell tech architecture. Security audit, speed optimization, Trust Operating System. MIT/Navy cyber background. Asks hard questions.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('cos')">
                    <div class="agent-name">Chief of Staff</div>
                    <div class="agent-role">COS - Operations Coordinator</div>
                    <div class="agent-duty">Synthesizes research into actionable plans. Coordinates marketing strategy. Slack workspace management. Master plan delivery.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('media')">
                    <div class="agent-name">Media Director</div>
                    <div class="agent-role">Content Creation Lead</div>
                    <div class="agent-duty">Social media content calendars. Platform best practices (X, LinkedIn, Facebook, IG, TikTok). Video vs image strategy. Engagement tactics.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('comms')">
                    <div class="agent-name">Communications</div>
                    <div class="agent-role">Community Management</div>
                    <div class="agent-duty">Response protocols. Comment management. Crisis communication. Templates for common scenarios. 80% automated response handling.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('intel')">
                    <div class="agent-name">Intelligence</div>
                    <div class="agent-role">Social Listening Lead</div>
                    <div class="agent-duty">Daily digest of relevant conversations. Keyword monitoring across X, Facebook, news. Opportunity flagging for Madison and Alexis.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('cfo')">
                    <div class="agent-name">CFO</div>
                    <div class="agent-role">Chief Financial Officer</div>
                    <div class="agent-duty">Financial planning, budget tracking, metrics analysis. Revenue forecasts. Cost optimization across all ventures.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('cro')">
                    <div class="agent-name">CRO</div>
                    <div class="agent-role">Chief Revenue Officer</div>
                    <div class="agent-duty">Revenue strategy, sales funnels, conversion optimization. Partnership deals. Pricing strategy across ventures.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('legal')">
                    <div class="agent-name">Legal</div>
                    <div class="agent-role">Legal Counsel</div>
                    <div class="agent-duty">Contract review, compliance, intellectual property. Risk assessment. Terms of service, privacy policies.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('hr')">
                    <div class="agent-name">HR</div>
                    <div class="agent-role">Human Resources</div>
                    <div class="agent-duty">Team coordination, contractor management, hiring strategy. Performance tracking. Culture and values alignment.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('ceo')">
                    <div class="agent-name">CEO</div>
                    <div class="agent-role">Chief Executive Officer</div>
                    <div class="agent-duty">Strategic vision, high-level decision support. Cross-venture coordination. Priority setting. Mark's strategic advisor.</div>
                </div>
                
                <div class="agent-card" onclick="openAgentDetail('coo')">
                    <div class="agent-name">COO</div>
                    <div class="agent-role">Chief Operating Officer</div>
                    <div class="agent-duty">Daily operations, process optimization, execution tracking. Bottleneck identification. Systems and workflow design.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal" onclick="if(event.target === this) closeChat()">
        <div class="modal-content" style="max-width: 1100px; padding: 20px;">
            <span class="modal-close" onclick="closeChat()">&times;</span>
            <h2 style="margin-bottom: 16px;">ðŸ’¬ Council Chat</h2>
            
            <div class="chat-container">
                <div class="chat-sidebar">
                    <div class="chat-sidebar-title">1-on-1</div>
                    <div class="chat-room" onclick="openRoom('madison', 'individual')" id="room-madison">
                        <div class="chat-room-name">Madison Harper</div>
                        <div class="chat-room-desc">Book Marketing</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('cmo', 'individual')" id="room-cmo">
                        <div class="chat-room-name">Alexis Monroe</div>
                        <div class="chat-room-desc">CMO</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('cto', 'individual')" id="room-cto">
                        <div class="chat-room-name">Marcus Steele</div>
                        <div class="chat-room-desc">CTO</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('cos', 'individual')" id="room-cos">
                        <div class="chat-room-name">Chief of Staff</div>
                        <div class="chat-room-desc">Coordinator</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('media', 'individual')" id="room-media">
                        <div class="chat-room-name">Media Director</div>
                        <div class="chat-room-desc">Content</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('comms', 'individual')" id="room-comms">
                        <div class="chat-room-name">Communications</div>
                        <div class="chat-room-desc">Community</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('intel', 'individual')" id="room-intel">
                        <div class="chat-room-name">Intelligence</div>
                        <div class="chat-room-desc">Social Listening</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('cfo', 'individual')" id="room-cfo">
                        <div class="chat-room-name">CFO</div>
                        <div class="chat-room-desc">Finance</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('cro', 'individual')" id="room-cro">
                        <div class="chat-room-name">CRO</div>
                        <div class="chat-room-desc">Revenue</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('ceo', 'individual')" id="room-ceo">
                        <div class="chat-room-name">CEO Advisor</div>
                        <div class="chat-room-desc">Strategy</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('coo', 'individual')" id="room-coo">
                        <div class="chat-room-name">COO</div>
                        <div class="chat-room-desc">Operations</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('legal', 'individual')" id="room-legal">
                        <div class="chat-room-name">Legal</div>
                        <div class="chat-room-desc">Compliance</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('hr', 'individual')" id="room-hr">
                        <div class="chat-room-name">HR</div>
                        <div class="chat-room-desc">People</div>
                    </div>
                    
                    <div class="chat-sidebar-title">Group Rooms</div>
                    <div class="chat-room" onclick="openRoom('marketing-team', 'group')" id="room-marketing-team">
                        <div class="chat-room-name">Marketing Team</div>
                        <div class="chat-room-desc">Madison, Alexis, Media, Comms</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('leadership', 'group')" id="room-leadership">
                        <div class="chat-room-name">Leadership</div>
                        <div class="chat-room-desc">CEO, COO, CFO, CRO</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('snaptosell-team', 'group')" id="room-snaptosell-team">
                        <div class="chat-room-name">SnapToSell Team</div>
                        <div class="chat-room-desc">Marcus, Alexis, Media</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('book-team', 'group')" id="room-book-team">
                        <div class="chat-room-name">Book Team</div>
                        <div class="chat-room-desc">Madison, Media, Comms, Intel</div>
                    </div>
                    <div class="chat-room" onclick="openRoom('all-hands', 'group')" id="room-all-hands">
                        <div class="chat-room-name">All Hands</div>
                        <div class="chat-room-desc">Full Council</div>
                    </div>
                </div>
                
                <div class="chat-main">
                    <div class="chat-header">
                        <div>
                            <div class="chat-header-name" id="chatRoomTitle">Select a room</div>
                            <div class="chat-header-status" id="chatRoomStatus">Choose an agent or group to start chatting</div>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div style="text-align:center;color:#888;padding:60px 20px;font-size:16px;">
                            Select an agent from the sidebar to start a conversation.<br><br>
                            <strong>1-on-1:</strong> Chat directly with any Council member<br>
                            <strong>Group Rooms:</strong> Multiple agents discuss together
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendChat()" disabled />
                        <button class="chat-send" id="chatSendBtn" onclick="sendChat()" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Venture Detail Modal -->
    <div id="ventureDetailModal" class="modal" onclick="if(event.target === this) closeVentureDetail()">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="modal-close" onclick="closeVentureDetail()">&times;</span>
            <div id="ventureDetailContent">
                <div style="text-align:center;color:#888;padding:40px;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Agent Detail Modal -->
    <div id="agentDetailModal" class="modal" onclick="if(event.target === this) closeAgentDetail()">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="modal-close" onclick="closeAgentDetail()">&times;</span>
            <div id="agentDetailContent">
                <div style="text-align:center;color:#888;padding:40px;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Council Feed Modal -->
    <div id="councilModal" class="modal" onclick="if(event.target === this) closeCouncil()">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="modal-close" onclick="closeCouncil()">&times;</span>
            <h2>Council Activity</h2>
            <div class="subtitle">See what the team is working on and discussing</div>
            
            <div class="feed-tabs">
                <div class="feed-tab active" onclick="switchFeedTab('activity')">Task Activity</div>
                <div class="feed-tab" onclick="switchFeedTab('conversations')">Conversations</div>
                <div class="feed-tab" onclick="switchFeedTab('output')">Work Output</div>
            </div>
            
            <div class="council-agent-filter" id="agentChips">
                <span class="agent-chip active" onclick="toggleAgentChip(this, 'all')">All</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'madison')">Madison</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'cmo')">Alexis</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'cto')">Marcus</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'cos')">COS</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'media')">Media</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'comms')">Comms</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'intel')">Intel</span>
                <span class="agent-chip" onclick="toggleAgentChip(this, 'allen')">Allen</span>
            </div>
            
            <div id="councilFeed" class="feed-list">
                <div style="text-align: center; color: #888; padding: 40px;">Loading activity...</div>
            </div>
        </div>
    </div>

    <!-- Task Management Modal -->
    <div id="tasksModal" class="modal" onclick="if(event.target === this) closeTasks()">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="modal-close" onclick="closeTasks()">&times;</span>
            <h2>Task Management</h2>
            <div class="subtitle">Create, assign, and track tasks across all ventures</div>
            
            <div class="task-controls">
                <select id="filterStatus" onchange="renderTasks()">
                    <option value="all">All Status</option>
                    <option value="pending" selected>Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="done">Done</option>
                </select>
                <select id="filterAgent" onchange="renderTasks()">
                    <option value="all">All Agents</option>
                    <option value="madison">Madison (Book)</option>
                    <option value="cmo">Alexis (CMO)</option>
                    <option value="cto">Marcus (CTO)</option>
                    <option value="cos">Chief of Staff</option>
                    <option value="media">Media</option>
                    <option value="comms">Communications</option>
                    <option value="intel">Intelligence</option>
                    <option value="cfo">CFO</option>
                    <option value="cro">CRO</option>
                    <option value="ceo">CEO</option>
                    <option value="coo">COO</option>
                    <option value="legal">Legal</option>
                    <option value="hr">HR</option>
                    <option value="allen">Allen</option>
                </select>
                <select id="filterPriority" onchange="renderTasks()">
                    <option value="all">All Priority</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <button onclick="toggleNewTask()">+ New Task</button>
            </div>
            
            <!-- New Task Form -->
            <div id="newTaskForm" class="new-task-form">
                <div class="form-row">
                    <select id="newTaskFrom">
                        <option value="mark">From: Mark</option>
                        <option value="ceo">From: CEO</option>
                        <option value="cos">From: COS</option>
                        <option value="cmo">From: CMO</option>
                        <option value="cto">From: CTO</option>
                        <option value="madison">From: Madison</option>
                    </select>
                    <select id="newTaskTo">
                        <option value="">Assign To...</option>
                        <option value="allen">Allen (Executor)</option>
                        <option value="madison">Madison (Book)</option>
                        <option value="cmo">Alexis (CMO)</option>
                        <option value="cto">Marcus (CTO)</option>
                        <option value="cos">Chief of Staff</option>
                        <option value="media">Media</option>
                        <option value="comms">Communications</option>
                        <option value="intel">Intelligence</option>
                        <option value="cfo">CFO</option>
                        <option value="cro">CRO</option>
                        <option value="ceo">CEO</option>
                        <option value="coo">COO</option>
                        <option value="legal">Legal</option>
                        <option value="hr">HR</option>
                    </select>
                    <select id="newTaskPriority">
                        <option value="high">High Priority</option>
                        <option value="urgent">Urgent</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-row">
                    <textarea id="newTaskText" placeholder="Describe the task..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn-cancel" onclick="toggleNewTask()">Cancel</button>
                    <button class="btn-submit" onclick="createTask()">Create Task</button>
                </div>
            </div>
            
            <div id="taskList" class="task-list">
                <div style="text-align: center; color: #888; padding: 40px;">Loading tasks...</div>
            </div>
        </div>
    </div>

    <script>
        const CORRECT_PASSWORD = 'Grizzly123';
        const SUPABASE_URL = 'https://cmdcitqfrzfmeghrvily.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZGNpdHFmcnpmbWVnaHJ2aWx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTgwMDIsImV4cCI6MjA4NTk3NDAwMn0.wrx599rkgJeSTa4N15DRSn4Tp1_3vrtwx2XF7HEviMo';

        // Check localStorage for saved auth
        window.onload = function() {
            if (localStorage.getItem('authenticated') === 'true') {
                showDashboard();
            }
            
            // Allow Enter key to submit password
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        };

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === CORRECT_PASSWORD) {
                localStorage.setItem('authenticated', 'true');
                showDashboard();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('passwordError').style.display = 'none';
                }, 3000);
            }
        }

        function showDashboard() {
            document.getElementById('passwordScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
            // Refresh data every 30 seconds
            setInterval(loadData, 30000);
        }

        async function loadData() {
            try {
                // Fetch tasks from Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const tasks = await response.json();
                    
                    // Count tasks by venture
                    const taskCounts = {
                        snaptosell: 0,
                        scripture: 0,
                        coaching: 0,
                        book: 0,
                        farm: 0,
                        aeromind: 0
                    };
                    
                    tasks.forEach(task => {
                        if (task.status === 'pending' || task.status === 'in_progress') {
                            const venture = task.venture || task.context_venture;
                            if (venture && taskCounts.hasOwnProperty(venture)) {
                                taskCounts[venture]++;
                            }
                        }
                    });
                    
                    // Update UI â€” venture counters live in hidden grid (preserve JS refs)
                    const _set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                    _set('snaptosell-tasks', taskCounts.snaptosell);
                    _set('coaching-tasks',   taskCounts.coaching);
                    _set('book-tasks',       taskCounts.book);
                    _set('farm-tasks',       taskCounts.farm);
                    _set('aeromind-tasks',   taskCounts.aeromind);

                    const totalActive = Object.values(taskCounts).reduce((a, b) => a + b, 0);
                    _set('total-tasks', totalActive); // legacy element (hidden)
                }
                
                // Fetch goals count
                const goalsResponse = await fetch(`${SUPABASE_URL}/rest/v1/goals?select=count`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'count=exact'
                    }
                });
                
                if (goalsResponse.ok) {
                    const count = goalsResponse.headers.get('Content-Range');
                    if (count) {
                        const total = count.split('/')[1];
                        const goalsEl = document.getElementById('total-goals');
                        if (goalsEl) goalsEl.textContent = total; // legacy element (hidden)
                    }
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Venture Profiles - who works on what
        const VENTURE_PROFILES = {
            'snaptosell': {
                name: 'SnapToSell',
                tagline: 'AI-Powered Marketplace Fraud Protection',
                color: '#FF6B35',
                team: {
                    'cto': { name: 'Marcus Steele', role: 'CTO - Tech Architecture' },
                    'cmo': { name: 'Alexis Monroe', role: 'CMO - Marketing Strategy' },
                    'media': { name: 'Media Director', role: 'Content & Social' },
                    'comms': { name: 'Communications', role: 'Response Protocols' },
                    'intel': { name: 'Intelligence', role: 'Social Listening' },
                    'allen': { name: 'Allen', role: 'Executor' }
                },
                external: ['Vigen Amirkhanyan ($7K/mo Dev CTO)', 'Arnold ($3K/mo Developer)'],
                keywords: ['snaptosell', 'snap', 'fraud', 'marketplace', 'trust', 'b2b', 'app']
            },
            'scripture': {
                name: 'Scripture Unlocked',
                tagline: 'Ancient Wisdom, Modern AI - YouTube Bible Study',
                color: '#D4AE39',
                team: {
                    'cmo': { name: 'Alexis Monroe', role: 'CMO - YouTube Growth' },
                    'media': { name: 'Media Director', role: 'Video Content' },
                    'comms': { name: 'Communications', role: 'Community Management' }
                },
                external: ['HeyGen (AI Avatars - Moses, Elijah, Solomon)'],
                keywords: ['scripture', 'youtube', 'bible', 'kjv', 'video']
            },
            'coaching': {
                name: 'BE âœ DO âœ HAVE',
                tagline: 'Creator Mindset Coaching',
                color: '#C9A54C',
                team: {
                    'cmo': { name: 'Alexis Monroe', role: 'CMO - Brand Strategy' },
                    'media': { name: 'Media Director', role: 'Content Creation' },
                    'cro': { name: 'CRO', role: 'Revenue & Funnels' }
                },
                external: [],
                keywords: ['coaching', 'creator', 'mindset', 'be do have']
            },
            'book': {
                name: 'The Enemy Within',
                tagline: '20 Years of Research. July 4, 2026',
                color: '#8B0000',
                team: {
                    'madison': { name: 'Madison Harper', role: 'Book Marketing Director' },
                    'media': { name: 'Media Director', role: 'Social Content' },
                    'comms': { name: 'Communications', role: 'Response Templates' },
                    'intel': { name: 'Intelligence', role: 'Social Listening' },
                    'allen': { name: 'Allen', role: 'Executor' }
                },
                external: ['Barry Hudock (Copyeditor)', 'Kyle Russ (Reviewer)', '19 Reviewers', '6 Literary Agents', '4 Publishers'],
                keywords: ['book', 'enemy within', 'launch', 'pre-order', 'arc', 'madison', 'landing page']
            },
            'farm': {
                name: 'Farm Flow',
                tagline: 'Voice-Guided Animal Care',
                color: '#228B22',
                team: {
                    'cto': { name: 'Marcus Steele', role: 'Tech Architecture' },
                    'coo': { name: 'COO', role: 'Operations Design' }
                },
                external: [],
                keywords: ['farm', 'animal', 'voice', 'agriculture']
            },
            'aeromind': {
                name: 'Aeromind Ops',
                tagline: 'AI Strategy Consulting',
                color: '#0EA5E9',
                team: {
                    'ceo': { name: 'CEO', role: 'Strategic Advisory' },
                    'cto': { name: 'Marcus Steele', role: 'Tech Consulting' },
                    'cmo': { name: 'Alexis Monroe', role: 'Marketing' }
                },
                external: [],
                keywords: ['aeromind', 'ai', 'consulting', 'evtol']
            }
        };
        
        async function openVenture(ventureSlug) {
            document.getElementById('ventureDetailModal').style.display = 'block';
            const container = document.getElementById('ventureDetailContent');
            container.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">Loading...</div>';
            
            const venture = VENTURE_PROFILES[ventureSlug];
            if (!venture) {
                container.innerHTML = '<div style="text-align:center;color:#e53e3e;padding:40px;">Venture not found</div>';
                return;
            }
            
            // Fetch all tasks
            let allVentureTasks = [];
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?select=*&order=created_at.desc`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (response.ok) allVentureTasks = await response.json();
            } catch(e) {}
            
            // Filter tasks relevant to this venture by team members and keywords
            const teamSlugs = Object.keys(venture.team);
            const relevantTasks = allVentureTasks.filter(t => {
                // Task involves a team member
                const involvesTeam = teamSlugs.includes(t.to_agent) || teamSlugs.includes(t.from_agent);
                if (!involvesTeam) return false;
                // Check if task content matches venture keywords
                const taskLower = t.task.toLowerCase();
                return venture.keywords.some(kw => taskLower.includes(kw));
            });
            
            // If keyword filtering is too strict, also include tasks between team members
            const teamTasks = allVentureTasks.filter(t => {
                return teamSlugs.includes(t.to_agent) && !relevantTasks.find(r => r.id === t.id);
            });
            
            // Combine: keyword-matched first, then general team tasks
            const allRelevant = [...relevantTasks, ...teamTasks];
            
            // Group tasks by team member
            const memberTasks = {};
            teamSlugs.forEach(slug => { memberTasks[slug] = []; });
            
            allRelevant.forEach(t => {
                if (teamSlugs.includes(t.to_agent)) {
                    if (!memberTasks[t.to_agent].find(existing => existing.id === t.id)) {
                        memberTasks[t.to_agent].push(t);
                    }
                }
            });
            
            // Calculate overall progress
            let totalTasks = 0, doneTasks = 0;
            Object.values(memberTasks).forEach(tasks => {
                totalTasks += tasks.length;
                doneTasks += tasks.filter(t => t.status === 'done').length;
            });
            const overallPct = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
            
            // Build HTML
            let html = `
                <h2 style="color:${venture.color};">${venture.name}</h2>
                <div class="subtitle" style="margin-bottom:5px;">${venture.tagline}</div>
                <div style="font-size:15px;color:#666;margin-bottom:20px;">${Object.keys(venture.team).length} team members Â· ${totalTasks} tasks Â· ${overallPct}% complete</div>
                
                <div class="detail-section">
                    <h3>ðŸ“Š Overall Progress</h3>
                    <div class="progress-label">
                        <span>${doneTasks} of ${totalTasks} tasks complete</span>
                        <span>${overallPct}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width:${overallPct}%;background:${venture.color};"></div>
                    </div>
                </div>`;
            
            // External team
            if (venture.external.length > 0) {
                html += `<div class="detail-section">
                    <h3>ðŸ‘¥ External Team</h3>
                    <div class="collab-list">`;
                venture.external.forEach(e => {
                    html += `<span class="collab-chip external">ðŸ“Œ ${e}</span>`;
                });
                html += `</div></div>`;
            }
            
            // Each team member
            html += `<div class="detail-section"><h3>ðŸ¢ Team & Tasks</h3>`;
            
            teamSlugs.forEach(slug => {
                const member = venture.team[slug];
                const tasks = memberTasks[slug];
                const memberDone = tasks.filter(t => t.status === 'done').length;
                const memberTotal = tasks.length;
                const memberPct = memberTotal > 0 ? Math.round((memberDone / memberTotal) * 100) : 0;
                const barColor = memberPct === 100 ? '#38a169' : memberPct > 0 ? '#3182ce' : '#dd6b20';
                
                html += `<div class="venture-member">
                    <div class="venture-member-header">
                        <div>
                            <span class="venture-member-name">${member.name}</span>
                            <span class="venture-member-role" style="margin-left:12px;">${member.role}</span>
                        </div>
                        <span style="font-size:15px;font-weight:700;color:${barColor};">${memberPct}%</span>
                    </div>
                    <div class="progress-bar-container" style="margin-top:0;margin-bottom:10px;">
                        <div class="progress-bar" style="width:${memberPct}%;background:${barColor};"></div>
                    </div>
                    <div class="venture-member-tasks">`;
                
                if (tasks.length === 0) {
                    html += '<div style="color:#888;font-size:14px;padding:8px 0;">No tasks assigned yet</div>';
                } else {
                    tasks.forEach(t => {
                        const fromName = AGENT_NAMES[t.from_agent] || t.from_agent;
                        const statusColor = t.status === 'done' ? '#38a169' : t.status === 'in_progress' ? '#3182ce' : '#dd6b20';
                        const preview = t.task.length > 200 ? t.task.substring(0, 200) + '...' : t.task;
                        html += `<div class="venture-task">
                            <div class="venture-task-meta">
                                <span>From: <strong>${fromName}</strong></span>
                                <span class="status-badge" style="background:${statusColor}20;color:${statusColor};">${t.status.replace('_',' ')}</span>
                            </div>
                            ${preview}
                        </div>`;
                    });
                }
                
                html += `</div></div>`;
            });
            
            html += `</div>`;
            
            // Venture Chat Section
            html += `
            <div class="detail-section" style="margin-top:30px;">
                <h3>ðŸ’¬ Project Chat</h3>
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;">`;
            
            // "All Team" chip
            const allAgentSlugs = teamSlugs.join(',');
            html += `<div class="agent-chip vc-agent-chip active" data-agents="${allAgentSlugs}" data-venture="${ventureSlug}" onclick="switchVentureAgent(this)" style="cursor:pointer;">All Team</div>`;
            
            teamSlugs.forEach(slug => {
                const name = venture.team[slug].name.split(' ')[0];
                html += `<div class="agent-chip vc-agent-chip" data-agents="${slug}" data-venture="${ventureSlug}" onclick="switchVentureAgent(this)" style="cursor:pointer;">${name}</div>`;
            });
            
            html += `</div>
                <div id="vcMessages" style="background:#0a0e1a;border:1px solid #2d5a8a;border-radius:10px;padding:16px;height:350px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;margin-bottom:12px;">
                    <div style="color:#5a6b7d;text-align:center;padding:40px 0;">Start a conversation about ${venture.name}...</div>
                </div>
                <div style="display:flex;gap:10px;">
                    <input id="vcInput" type="text" placeholder="Ask the team about ${venture.name}..." 
                        style="flex:1;padding:14px 18px;font-size:22px;border:1px solid #2d5a8a;border-radius:10px;background:#0a0e1a;color:#e0e0e0;outline:none;font-family:inherit;"
                        onkeydown="if(event.key==='Enter')sendVentureChat()">
                    <button onclick="sendVentureChat()" 
                        style="padding:14px 28px;background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;border:none;border-radius:10px;font-size:22px;font-weight:600;cursor:pointer;">Send</button>
                </div>
            </div>`;
            
            container.innerHTML = html;
            
            // Store current venture context
            window._ventureChat = {
                slug: ventureSlug,
                name: venture.name,
                tagline: venture.tagline,
                agents: allAgentSlugs.split(','),
                history: []
            };
            
            // Load previous messages from Supabase
            loadVentureHistory(ventureSlug);
        }
        
        async function loadVentureHistory(ventureSlug) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/messages?select=*&metadata->>type=eq.venture_chat&metadata->>venture=eq.${ventureSlug}&order=created_at.asc&limit=50`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) return;
                const msgs = await response.json();
                if (msgs.length === 0) return;
                
                const container = document.getElementById('vcMessages');
                container.innerHTML = '';
                
                msgs.forEach(m => {
                    const isUser = m.direction === 'outgoing';
                    const agentName = m.metadata?.agent_name || 'Agent';
                    appendVentureMsg(isUser ? 'You' : agentName, m.text, isUser ? 'user' : 'agent');
                    
                    // Rebuild history for API context
                    if (window._ventureChat) {
                        window._ventureChat.history.push({
                            role: isUser ? 'user' : 'assistant',
                            content: isUser ? m.text : `[${agentName}]: ${m.text}`
                        });
                    }
                });
                
                container.scrollTop = container.scrollHeight;
            } catch(e) { console.error('Failed to load venture history:', e); }
        }
        
        function switchVentureAgent(chip) {
            document.querySelectorAll('.vc-agent-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            if (window._ventureChat) {
                window._ventureChat.agents = chip.dataset.agents.split(',');
            }
        }
        
        async function sendVentureChat() {
            const input = document.getElementById('vcInput');
            const msg = input.value.trim();
            if (!msg || !window._ventureChat) return;
            
            input.value = '';
            appendVentureMsg('You', msg, 'user');
            
            const vc = window._ventureChat;
            
            // Save user message to Supabase
            saveVentureMsg(vc.slug, 'outgoing', msg, 'You', null);
            
            // Show typing
            const typingEl = document.createElement('div');
            typingEl.className = 'chat-msg agent';
            typingEl.style.cssText = 'font-style:italic;color:#5a6b7d;';
            typingEl.textContent = 'Thinking...';
            typingEl.id = 'vcTyping';
            document.getElementById('vcMessages').appendChild(typingEl);
            document.getElementById('vcMessages').scrollTop = document.getElementById('vcMessages').scrollHeight;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agents: vc.agents,
                        message: msg,
                        history: vc.history.slice(-20),
                        roomType: vc.agents.length > 1 ? 'group' : 'individual',
                        ventureContext: {
                            name: vc.name,
                            brief: vc.tagline
                        }
                    })
                });
                
                const typing = document.getElementById('vcTyping');
                if (typing) typing.remove();
                
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                
                vc.history.push({ role: 'user', content: msg });
                
                data.responses.forEach(r => {
                    appendVentureMsg(`${r.name} (${r.role})`, r.content, 'agent');
                    vc.history.push({ role: 'assistant', content: `[${r.name}]: ${r.content}` });
                    // Save agent response to Supabase
                    saveVentureMsg(vc.slug, 'incoming', r.content, r.name, r.agent);
                });
                
            } catch(e) {
                const typing = document.getElementById('vcTyping');
                if (typing) typing.remove();
                appendVentureMsg('System', 'Error getting response. Try again.', 'agent');
            }
            
            document.getElementById('vcMessages').scrollTop = document.getElementById('vcMessages').scrollHeight;
        }
        
        function appendVentureMsg(sender, text, type) {
            const container = document.getElementById('vcMessages');
            // Clear placeholder
            if (container.querySelector('div[style*="text-align:center"]')) {
                container.innerHTML = '';
            }
            const div = document.createElement('div');
            div.className = `chat-msg ${type}`;
            div.innerHTML = `<div class="chat-msg-sender">${sender}</div><div class="chat-msg-text">${text.replace(/\n/g, '<br>')}</div>`;
            container.appendChild(div);
        }
        
        async function saveVentureMsg(venture, direction, text, agentName, agentSlug) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        text: text,
                        direction: direction,
                        chat_id: 0,
                        user_id: 0,
                        metadata: {
                            type: 'venture_chat',
                            venture: venture,
                            agent: agentSlug,
                            agent_name: agentName
                        }
                    })
                });
            } catch(e) { console.error('Failed to save venture msg:', e); }
        }
        
        function closeVentureDetail() {
            window._ventureChat = null;
            document.getElementById('ventureDetailModal').style.display = 'none';
        }
        
        // Chat System
        const GROUP_ROOMS = {
            'marketing-team': { name: 'Marketing Team', agents: ['madison', 'cmo', 'media', 'comms'] },
            'leadership': { name: 'Leadership', agents: ['ceo', 'coo', 'cfo', 'cro'] },
            'snaptosell-team': { name: 'SnapToSell Team', agents: ['cto', 'cmo', 'media'] },
            'book-team': { name: 'Book Team', agents: ['madison', 'media', 'comms', 'intel'] },
            'all-hands': { name: 'All Hands', agents: ['madison', 'cmo', 'cto', 'cos', 'media', 'comms', 'intel', 'cfo', 'cro', 'ceo', 'coo', 'legal', 'hr'] }
        };
        
        let currentRoom = null;
        let currentRoomType = null;
        let chatHistories = {};
        
        function showChat() {
            document.getElementById('chatModal').style.display = 'block';
        }
        
        function closeChat() {
            document.getElementById('chatModal').style.display = 'none';
        }
        
        function openRoom(roomId, type) {
            currentRoom = roomId;
            currentRoomType = type;
            
            // Update sidebar active state
            document.querySelectorAll('.chat-room').forEach(r => r.classList.remove('active'));
            document.getElementById('room-' + roomId).classList.add('active');
            
            // Update header
            if (type === 'individual') {
                const profile = AGENT_PROFILES[roomId];
                document.getElementById('chatRoomTitle').textContent = profile ? profile.name : roomId;
                document.getElementById('chatRoomStatus').textContent = profile ? profile.role : '';
            } else {
                const group = GROUP_ROOMS[roomId];
                document.getElementById('chatRoomTitle').textContent = group ? group.name : roomId;
                document.getElementById('chatRoomStatus').textContent = group ? group.agents.map(a => AGENT_NAMES[a] || a).join(', ') : '';
            }
            
            // Enable input
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
            document.getElementById('chatInput').focus();
            
            // Load history
            if (!chatHistories[roomId]) chatHistories[roomId] = [];
            renderChat();
        }
        
        function renderChat() {
            const container = document.getElementById('chatMessages');
            const history = chatHistories[currentRoom] || [];
            
            if (history.length === 0) {
                const roomName = currentRoomType === 'individual' 
                    ? (AGENT_PROFILES[currentRoom]?.name || currentRoom) 
                    : (GROUP_ROOMS[currentRoom]?.name || currentRoom);
                container.innerHTML = `<div style="text-align:center;color:#888;padding:60px 20px;font-size:16px;">
                    Start a conversation with ${roomName}
                </div>`;
                return;
            }
            
            container.innerHTML = history.map(msg => {
                if (msg.type === 'user') {
                    return `<div class="chat-msg user">
                        <div class="chat-msg-sender">Mark</div>
                        <div class="chat-msg-text">${msg.text}</div>
                    </div>`;
                } else {
                    return `<div class="chat-msg agent">
                        <div class="chat-msg-sender">${msg.sender}</div>
                        <div class="chat-msg-text">${msg.text}</div>
                    </div>`;
                }
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || !currentRoom) return;
            
            input.value = '';
            
            // Add user message
            if (!chatHistories[currentRoom]) chatHistories[currentRoom] = [];
            chatHistories[currentRoom].push({ type: 'user', text: message });
            renderChat();
            
            // Show typing indicator
            const container = document.getElementById('chatMessages');
            container.innerHTML += '<div class="chat-typing" id="typingIndicator">Thinking...</div>';
            container.scrollTop = container.scrollHeight;
            
            // Disable input while waiting
            document.getElementById('chatSendBtn').disabled = true;
            
            // Determine agents to call
            let agents;
            if (currentRoomType === 'individual') {
                agents = [currentRoom];
            } else {
                agents = GROUP_ROOMS[currentRoom]?.agents || [];
            }
            
            // Build conversation history for API
            const apiHistory = chatHistories[currentRoom]
                .filter(m => m !== chatHistories[currentRoom][chatHistories[currentRoom].length - 1])
                .slice(-10)
                .map(m => ({
                    role: m.type === 'user' ? 'user' : 'assistant',
                    content: m.type === 'user' ? m.text : `[${m.sender}]: ${m.text}`
                }));
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agents: agents,
                        message: message,
                        history: apiHistory,
                        roomType: currentRoomType
                    })
                });
                
                // Remove typing indicator
                const typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
                
                if (response.ok) {
                    const data = await response.json();
                    data.responses.forEach(r => {
                        chatHistories[currentRoom].push({
                            type: 'agent',
                            sender: r.name,
                            text: r.content
                        });
                    });
                } else {
                    chatHistories[currentRoom].push({
                        type: 'agent',
                        sender: 'System',
                        text: 'Error: Could not reach agent. Check API connection.'
                    });
                }
            } catch (error) {
                const typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
                chatHistories[currentRoom].push({
                    type: 'agent',
                    sender: 'System',
                    text: 'Connection error. Please try again.'
                });
            }
            
            document.getElementById('chatSendBtn').disabled = false;
            renderChat();
        }
        
        // Agent Detail Profiles
        const AGENT_PROFILES = {
            'madison': {
                name: 'Madison Harper', role: 'Book Marketing Director',
                ventures: ['The Enemy Within'],
                collaborators: ['Media', 'Comms', 'Intel'],
                external: ['Barry Hudock (Copyeditor)', 'Kyle Russ (Reviewer)', '19 Reviewers', '6 Literary Agents', '4 Publishers'],
                assets: ['book-knowledge-brief.md', 'marketing-research-brief.md', 'board-knowledge/russell-brunson.md', 'board-knowledge/jay-abraham.md'],
                skills: 'Book marketing, ARC recruitment, Amazon optimization, podcast tours, email funnels, launch strategy'
            },
            'cmo': {
                name: 'Alexis Monroe', role: 'CMO - Chief Marketing Officer',
                ventures: ['SnapToSell', 'Scripture Unlocked'],
                collaborators: ['Marcus (CTO)', 'Media', 'Comms', 'Intel'],
                external: ['Vigen Amirkhanyan (Dev CTO)', 'Arnold (Developer)'],
                assets: ['snaptosell/master-instructions.md', 'snaptosell/trust-operating-system.md', 'marketing-research-brief.md', 'board-knowledge/russell-brunson.md'],
                skills: 'B2B SaaS marketing, YouTube growth, funnel design, conversion optimization, Brunson/Abraham/Martell frameworks'
            },
            'cto': {
                name: 'Marcus Steele', role: 'CTO - Chief Technology Officer',
                ventures: ['SnapToSell'],
                collaborators: ['Alexis (CMO)', 'Allen (Executor)'],
                external: ['Vigen Amirkhanyan ($7K/mo Dev CTO)', 'Arnold ($3K/mo Developer)'],
                assets: ['snaptosell/master-instructions.md', 'snaptosell/trust-operating-system.md', 'CTO-ASSIGNMENT-DRAFT.md', 'CTO-PROFILE-VISIONARY.md'],
                skills: 'Security architecture, performance optimization, technical due diligence, MIT/Navy cyber background'
            },
            'cos': {
                name: 'Chief of Staff', role: 'Operations Coordinator',
                ventures: ['All (cross-venture)'],
                collaborators: ['All Council Members'],
                external: [],
                assets: ['marketing-research-brief.md', 'COUNCIL.md', 'TEAM-ROSTER.md'],
                skills: 'Synthesis, coordination, project management, strategic planning, master plan delivery'
            },
            'media': {
                name: 'Media Director', role: 'Content Creation Lead',
                ventures: ['All (content)'],
                collaborators: ['Madison', 'Alexis (CMO)', 'Comms'],
                external: ['Buffer (scheduling)', 'HeyGen (AI avatars)'],
                assets: ['social-listening-setup.md', 'marketing-research-brief.md'],
                skills: 'Content calendars, platform algorithms, visual storytelling, hashtag strategy, engagement tactics'
            },
            'comms': {
                name: 'Communications', role: 'Community Management',
                ventures: ['All (responses)'],
                collaborators: ['Madison', 'Alexis (CMO)', 'Media'],
                external: [],
                assets: ['marketing-research-brief.md', 'USER.md (Mark\'s voice)'],
                skills: 'Crisis management, tone matching, community building, response protocols, conflict de-escalation'
            },
            'intel': {
                name: 'Intelligence', role: 'Social Listening Lead',
                ventures: ['SnapToSell', 'The Enemy Within'],
                collaborators: ['Madison', 'Alexis (CMO)'],
                external: [],
                assets: ['social-listening-setup.md'],
                skills: 'OSINT, social listening, trend analysis, keyword monitoring, opportunity identification'
            },
            'cfo': {
                name: 'CFO', role: 'Chief Financial Officer',
                ventures: ['All (financial)'],
                collaborators: ['CRO', 'COO'],
                external: [],
                assets: [],
                skills: 'Financial modeling, budget management, metrics analysis, revenue forecasting'
            },
            'cro': {
                name: 'CRO', role: 'Chief Revenue Officer',
                ventures: ['All (revenue)'],
                collaborators: ['Alexis (CMO)', 'CFO'],
                external: [],
                assets: [],
                skills: 'Sales funnels, pricing psychology, partnership negotiation, conversion optimization'
            },
            'ceo': {
                name: 'CEO', role: 'Chief Executive Officer',
                ventures: ['All (strategic)'],
                collaborators: ['All C-suite'],
                external: [],
                assets: [],
                skills: 'Strategic planning, systems thinking, priority arbitrage, vision casting'
            },
            'coo': {
                name: 'COO', role: 'Chief Operating Officer',
                ventures: ['All (operations)'],
                collaborators: ['COS', 'All departments'],
                external: [],
                assets: [],
                skills: 'Operations management, process design, efficiency optimization, execution'
            },
            'legal': {
                name: 'Legal Counsel', role: 'Legal',
                ventures: ['All (compliance)'],
                collaborators: ['All departments'],
                external: [],
                assets: [],
                skills: 'Contract law, IP protection, compliance, risk management, terms of service'
            },
            'hr': {
                name: 'HR', role: 'Human Resources',
                ventures: ['All (people)'],
                collaborators: ['All departments'],
                external: [],
                assets: [],
                skills: 'Talent management, culture building, performance evaluation, hiring strategy'
            }
        };
        
        async function openAgentDetail(slug) {
            document.getElementById('agentDetailModal').style.display = 'block';
            const container = document.getElementById('agentDetailContent');
            container.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">Loading...</div>';
            
            const profile = AGENT_PROFILES[slug];
            if (!profile) {
                container.innerHTML = '<div style="text-align:center;color:#e53e3e;padding:40px;">Agent not found</div>';
                return;
            }
            
            // Fetch tasks for this agent
            let agentTasks = [];
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?select=*&or=(to_agent.eq.${slug},from_agent.eq.${slug})&order=created_at.desc`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (response.ok) agentTasks = await response.json();
            } catch(e) {}
            
            const pendingTasks = agentTasks.filter(t => t.status === 'pending' && t.to_agent === slug);
            const inProgressTasks = agentTasks.filter(t => t.status === 'in_progress' && t.to_agent === slug);
            const doneTasks = agentTasks.filter(t => t.status === 'done' && t.to_agent === slug);
            const sentTasks = agentTasks.filter(t => t.from_agent === slug);
            const totalAssigned = pendingTasks.length + inProgressTasks.length + doneTasks.length;
            const progressPct = totalAssigned > 0 ? Math.round((doneTasks.length / totalAssigned) * 100) : 0;
            
            let html = `
                <h2>${profile.name}</h2>
                <div class="subtitle" style="margin-bottom: 5px;">${profile.role}</div>
                <div style="font-size:14px;color:#666;margin-bottom:25px;">Ventures: ${profile.ventures.join(', ')} Â· Skills: ${profile.skills}</div>
                
                <!-- Progress -->
                <div class="detail-section">
                    <h3>ðŸ“Š Progress</h3>
                    <div class="progress-label">
                        <span>${doneTasks.length} of ${totalAssigned} tasks complete</span>
                        <span>${progressPct}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width:${progressPct}%;background:${progressPct === 100 ? '#38a169' : progressPct > 0 ? '#3182ce' : '#dd6b20'};"></div>
                    </div>
                </div>
                
                <!-- Active Tasks -->
                <div class="detail-section">
                    <h3>ðŸ”¥ Active Tasks (${pendingTasks.length + inProgressTasks.length})</h3>`;
            
            if (pendingTasks.length + inProgressTasks.length === 0) {
                html += '<div class="empty-state">No active tasks</div>';
            } else {
                [...inProgressTasks, ...pendingTasks].forEach(t => {
                    const fromName = AGENT_NAMES[t.from_agent] || t.from_agent;
                    const time = new Date(t.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const statusColor = t.status === 'in_progress' ? '#3182ce' : '#dd6b20';
                    const preview = t.task.length > 250 ? t.task.substring(0, 250) + '...' : t.task;
                    html += `<div class="detail-task" style="border-left:4px solid ${statusColor};">
                        <div class="detail-task-header">
                            <span class="detail-task-from">From: <strong>${fromName}</strong> Â· ${time}</span>
                            <span class="status-badge" style="background:${statusColor}20;color:${statusColor};">${t.status.replace('_',' ')}</span>
                        </div>
                        <div class="detail-task-body">${preview}</div>
                    </div>`;
                });
            }
            
            html += `</div>
                
                <!-- Completed Work -->
                <div class="detail-section">
                    <h3>âœ… Completed Work (${doneTasks.length})</h3>`;
            
            if (doneTasks.length === 0) {
                html += '<div class="empty-state">No completed work yet</div>';
            } else {
                doneTasks.forEach(t => {
                    const time = t.completed_at ? new Date(t.completed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                    const preview = t.task.length > 200 ? t.task.substring(0, 200) + '...' : t.task;
                    html += `<div class="detail-task" style="border-left:4px solid #38a169;">
                        <div class="detail-task-header">
                            <span class="detail-task-from">Completed ${time}</span>
                            <span class="status-badge status-done">done</span>
                        </div>
                        <div class="detail-task-body">${preview}</div>
                    </div>`;
                });
            }
            
            html += `</div>
                
                <!-- Tasks Sent to Others -->
                <div class="detail-section">
                    <h3>ðŸ“¤ Tasks Assigned to Others (${sentTasks.length})</h3>`;
            
            if (sentTasks.length === 0) {
                html += '<div class="empty-state">No tasks sent</div>';
            } else {
                sentTasks.slice(0, 5).forEach(t => {
                    const toName = AGENT_NAMES[t.to_agent] || t.to_agent;
                    const preview = t.task.length > 150 ? t.task.substring(0, 150) + '...' : t.task;
                    const statusColor = t.status === 'done' ? '#38a169' : t.status === 'in_progress' ? '#3182ce' : '#dd6b20';
                    html += `<div class="detail-task">
                        <div class="detail-task-header">
                            <span class="detail-task-from">â†’ <strong>${toName}</strong></span>
                            <span class="status-badge" style="background:${statusColor}20;color:${statusColor};">${t.status.replace('_',' ')}</span>
                        </div>
                        <div class="detail-task-body">${preview}</div>
                    </div>`;
                });
                if (sentTasks.length > 5) html += `<div class="empty-state">+ ${sentTasks.length - 5} more</div>`;
            }
            
            html += `</div>
                
                <!-- Collaborators -->
                <div class="detail-section">
                    <h3>ðŸ¤ Collaborators</h3>
                    <div class="collab-list">`;
            
            profile.collaborators.forEach(c => {
                html += `<span class="collab-chip">${c}</span>`;
            });
            profile.external.forEach(c => {
                html += `<span class="collab-chip external">ðŸ“Œ ${c}</span>`;
            });
            if (profile.collaborators.length === 0 && profile.external.length === 0) {
                html += '<div class="empty-state">No collaborators listed</div>';
            }
            
            html += `</div></div>
                
                <!-- Assets & Resources -->
                <div class="detail-section">
                    <h3>ðŸ“ Assets & Resources</h3>
                    <div class="asset-list">`;
            
            if (profile.assets.length === 0) {
                html += '<div class="empty-state">No assets assigned</div>';
            } else {
                profile.assets.forEach(a => {
                    html += `<div class="asset-item">ðŸ“„ ${a}</div>`;
                });
            }
            
            html += `</div></div>`;
            
            container.innerHTML = html;
        }
        
        function closeAgentDetail() {
            document.getElementById('agentDetailModal').style.display = 'none';
        }
        
        // Council Feed
        let currentFeedTab = 'activity';
        let currentAgentFilter = 'all';
        
        function showCouncil() {
            document.getElementById('councilModal').style.display = 'block';
            loadCouncilFeed();
        }
        
        function closeCouncil() {
            document.getElementById('councilModal').style.display = 'none';
        }
        
        function switchFeedTab(tab) {
            currentFeedTab = tab;
            document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadCouncilFeed();
        }
        
        function toggleAgentChip(el, agent) {
            document.querySelectorAll('.agent-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentAgentFilter = agent;
            loadCouncilFeed();
        }
        
        async function loadCouncilFeed() {
            const feed = document.getElementById('councilFeed');
            feed.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">Loading...</div>';
            
            if (currentFeedTab === 'activity') {
                await loadTaskActivity();
            } else if (currentFeedTab === 'conversations') {
                await loadConversations();
            } else if (currentFeedTab === 'output') {
                await loadWorkOutput();
            }
        }
        
        async function loadTaskActivity() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?select=*&order=created_at.desc&limit=30`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (!response.ok) throw new Error('Failed');
                const tasks = await response.json();
                
                let filtered = tasks;
                if (currentAgentFilter !== 'all') {
                    filtered = tasks.filter(t => t.to_agent === currentAgentFilter || t.from_agent === currentAgentFilter);
                }
                
                if (filtered.length === 0) {
                    document.getElementById('councilFeed').innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No activity for this agent</div>';
                    return;
                }
                
                const html = filtered.map(t => {
                    const fromName = AGENT_NAMES[t.from_agent] || t.from_agent;
                    const toName = AGENT_NAMES[t.to_agent] || t.to_agent;
                    const time = new Date(t.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const statusColor = t.status === 'done' ? '#38a169' : t.status === 'in_progress' ? '#3182ce' : '#dd6b20';
                    const taskPreview = t.task.length > 300 ? t.task.substring(0, 300) + '...' : t.task;
                    
                    return `<div class="feed-item">
                        <div class="feed-item-header">
                            <div>
                                <span class="feed-agent">${fromName} â†’ ${toName}</span>
                                <span class="status-badge" style="background:${statusColor}20;color:${statusColor};margin-left:8px;">${t.status.replace('_',' ')}</span>
                            </div>
                            <span class="feed-time">${time}</span>
                        </div>
                        <div class="feed-body">${taskPreview}</div>
                    </div>`;
                }).join('');
                
                document.getElementById('councilFeed').innerHTML = html;
            } catch (e) {
                document.getElementById('councilFeed').innerHTML = '<div style="text-align:center;color:#e53e3e;padding:40px;">Error loading activity</div>';
            }
        }
        
        async function loadConversations() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/conversations?select=*&order=created_at.desc&limit=30`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (!response.ok) throw new Error('Failed');
                const convos = await response.json();
                
                if (convos.length === 0) {
                    document.getElementById('councilFeed').innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No conversations yet</div>';
                    return;
                }
                
                const html = convos.map(c => {
                    const time = new Date(c.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const preview = c.content.length > 400 ? c.content.substring(0, 400) + '...' : c.content;
                    const direction = c.role === 'user' ? 'incoming' : 'outgoing';
                    const label = c.role === 'user' ? 'Mark' : 'Council';
                    
                    return `<div class="feed-item">
                        <div class="feed-item-header">
                            <div>
                                <span class="feed-agent">${label}</span>
                                <span class="feed-direction ${direction}">${direction}</span>
                            </div>
                            <span class="feed-time">${time}</span>
                        </div>
                        <div class="feed-body">${preview}</div>
                    </div>`;
                }).join('');
                
                document.getElementById('councilFeed').innerHTML = html;
            } catch (e) {
                document.getElementById('councilFeed').innerHTML = '<div style="text-align:center;color:#e53e3e;padding:40px;">Error loading conversations</div>';
            }
        }
        
        async function loadWorkOutput() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?select=*&status=eq.done&order=completed_at.desc&limit=20`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (!response.ok) throw new Error('Failed');
                const tasks = await response.json();
                
                let filtered = tasks;
                if (currentAgentFilter !== 'all') {
                    filtered = tasks.filter(t => t.to_agent === currentAgentFilter);
                }
                
                if (filtered.length === 0) {
                    document.getElementById('councilFeed').innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No completed work yet. Tasks need to be executed first.</div>';
                    return;
                }
                
                const html = filtered.map(t => {
                    const toName = AGENT_NAMES[t.to_agent] || t.to_agent;
                    const completed = t.completed_at ? new Date(t.completed_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Unknown';
                    const taskPreview = t.task.length > 300 ? t.task.substring(0, 300) + '...' : t.task;
                    
                    return `<div class="feed-item">
                        <div class="feed-item-header">
                            <div>
                                <span class="feed-agent">${toName}</span>
                                <span class="status-badge status-done">completed</span>
                            </div>
                            <span class="feed-time">${completed}</span>
                        </div>
                        <div class="feed-body">${taskPreview}</div>
                    </div>`;
                }).join('');
                
                document.getElementById('councilFeed').innerHTML = html;
            } catch (e) {
                document.getElementById('councilFeed').innerHTML = '<div style="text-align:center;color:#e53e3e;padding:40px;">Error loading work output</div>';
            }
        }
        
        function showAgents() {
            document.getElementById('agentsModal').style.display = 'block';
        }
        
        function closeAgents() {
            document.getElementById('agentsModal').style.display = 'none';
        }
        
        // Task Management
        let allTasks = [];
        const AGENT_NAMES = {
            'madison': 'Madison', 'cmo': 'Alexis (CMO)', 'cto': 'Marcus (CTO)',
            'cos': 'Chief of Staff', 'media': 'Media', 'comms': 'Comms',
            'intel': 'Intel', 'cfo': 'CFO', 'cro': 'CRO', 'ceo': 'CEO',
            'coo': 'COO', 'legal': 'Legal', 'hr': 'HR', 'allen': 'Allen',
            'mark': 'Mark', 'allen_activation': 'Allen'
        };
        
        function showTasks() {
            document.getElementById('tasksModal').style.display = 'block';
            loadTasks();
        }
        
        function closeTasks() {
            document.getElementById('tasksModal').style.display = 'none';
        }
        
        function toggleNewTask() {
            const form = document.getElementById('newTaskForm');
            form.classList.toggle('active');
        }
        
        async function loadTasks() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (response.ok) {
                    allTasks = await response.json();
                    renderTasks();
                }
            } catch (error) {
                document.getElementById('taskList').innerHTML = '<div style="text-align:center;color:#e53e3e;padding:40px;">Error loading tasks</div>';
            }
        }
        
        function renderTasks() {
            const statusFilter = document.getElementById('filterStatus').value;
            const agentFilter = document.getElementById('filterAgent').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            
            let filtered = allTasks.filter(t => {
                if (statusFilter !== 'all' && t.status !== statusFilter) return false;
                if (agentFilter !== 'all' && t.to_agent !== agentFilter && t.from_agent !== agentFilter) return false;
                if (priorityFilter !== 'all' && t.priority !== priorityFilter) return false;
                return true;
            });
            
            if (filtered.length === 0) {
                document.getElementById('taskList').innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No tasks match filters</div>';
                return;
            }
            
            const html = filtered.map(t => {
                const fromName = AGENT_NAMES[t.from_agent] || t.from_agent;
                const toName = AGENT_NAMES[t.to_agent] || t.to_agent;
                const created = new Date(t.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const taskPreview = t.task.length > 200 ? t.task.substring(0, 200) + '...' : t.task;
                
                let actions = '';
                if (t.status === 'pending') {
                    actions = `<button class="btn-start" onclick="updateTask('${t.id}', 'in_progress')">Start</button>
                               <button class="btn-done" onclick="updateTask('${t.id}', 'done')">Done</button>
                               <button class="btn-delete" onclick="deleteTask('${t.id}')">Delete</button>`;
                } else if (t.status === 'in_progress') {
                    actions = `<button class="btn-done" onclick="updateTask('${t.id}', 'done')">Complete</button>
                               <button class="btn-delete" onclick="deleteTask('${t.id}')">Delete</button>`;
                } else {
                    actions = `<button class="btn-delete" onclick="deleteTask('${t.id}')">Delete</button>`;
                }
                
                return `<div class="task-item priority-${t.priority}">
                    <div class="task-header">
                        <div class="task-agents"><strong>${fromName}</strong> â†’ <strong>${toName}</strong></div>
                        <span class="status-badge status-${t.status}">${t.status.replace('_', ' ')}</span>
                    </div>
                    <div class="task-body">${taskPreview}</div>
                    <div class="task-footer">
                        <div class="task-meta">${t.priority.toUpperCase()} Â· ${created}</div>
                        <div class="task-actions">${actions}</div>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('taskList').innerHTML = html;
        }
        
        async function updateTask(id, newStatus) {
            try {
                const body = { status: newStatus };
                if (newStatus === 'done') body.completed_at = new Date().toISOString();
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(body)
                });
                if (response.ok) {
                    loadTasks();
                    loadData();
                }
            } catch (error) {
                alert('Error updating task');
            }
        }
        
        async function deleteTask(id) {
            if (!confirm('Delete this task?')) return;
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (response.ok) {
                    loadTasks();
                    loadData();
                }
            } catch (error) {
                alert('Error deleting task');
            }
        }
        
        async function createTask() {
            const from = document.getElementById('newTaskFrom').value;
            const to = document.getElementById('newTaskTo').value;
            const priority = document.getElementById('newTaskPriority').value;
            const task = document.getElementById('newTaskText').value.trim();

            if (!to) { alert('Select who to assign this to'); return; }
            if (!task) { alert('Enter a task description'); return; }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        from_agent: from,
                        to_agent: to,
                        task: task,
                        priority: priority,
                        status: 'pending',
                        created_by: 'dashboard'
                    })
                });
                if (response.ok) {
                    document.getElementById('newTaskText').value = '';
                    document.getElementById('newTaskTo').value = '';
                    toggleNewTask();
                    loadTasks();
                    loadData();
                }
            } catch (error) {
                alert('Error creating task');
            }
        }

        // ===== SIDEBAR ACTIVE STATE =====
        function setSidebarActive(el) {
            document.querySelectorAll('.sidebar-nav-item').forEach(item => item.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        // ===== SIDEBAR PANEL TOGGLE =====
        let activeSidebarPanel = null;

        function toggleSidebarPanel(panelId) {
            const panel = document.getElementById('sidebarPanel');
            const allContent = document.querySelectorAll('.sidebar-panel-content');
            const targetContent = document.getElementById('panel-' + panelId);

            // Clicking the already-active panel closes it
            if (activeSidebarPanel === panelId && panel.classList.contains('open')) {
                panel.classList.remove('open');
                allContent.forEach(c => c.classList.remove('active'));
                activeSidebarPanel = null;
                return;
            }

            // Switch to the target panel
            allContent.forEach(c => c.classList.remove('active'));
            if (targetContent) targetContent.classList.add('active');
            panel.classList.add('open');
            activeSidebarPanel = panelId;
        }
    </script>
    
    <!-- Circuit Board Background -->
    <script>
    (function() {
        const canvas = document.getElementById('circuitCanvas');
        const ctx = canvas.getContext('2d');
        let w, h, nodes, traces, pulses;
        
        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            init();
        }
        
        function init() {
            nodes = [];
            traces = [];
            pulses = [];
            
            const spacing = 60;
            const cols = Math.ceil(w / spacing) + 1;
            const rows = Math.ceil(h / spacing) + 1;
            
            // Create grid nodes with slight randomization
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (Math.random() > 0.4) {
                        nodes.push({
                            x: c * spacing + (Math.random() - 0.5) * 10,
                            y: r * spacing + (Math.random() - 0.5) * 10,
                            size: Math.random() > 0.85 ? 3 + Math.random() * 3 : 1.5 + Math.random(),
                            type: Math.random() > 0.9 ? 'chip' : Math.random() > 0.7 ? 'junction' : 'node',
                            glow: Math.random() * 0.5
                        });
                    }
                }
            }
            
            // Create traces between nearby nodes
            for (let i = 0; i < nodes.length; i++) {
                const n = nodes[i];
                for (let j = i + 1; j < nodes.length; j++) {
                    const m = nodes[j];
                    const dx = m.x - n.x;
                    const dy = m.y - n.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    // Only connect nearby nodes, prefer horizontal/vertical
                    if (dist < spacing * 1.8 && Math.random() > 0.55) {
                        const isOrthogonal = Math.abs(dx) < 15 || Math.abs(dy) < 15;
                        if (isOrthogonal || Math.random() > 0.7) {
                            traces.push({
                                x1: n.x, y1: n.y,
                                x2: m.x, y2: m.y,
                                bend: !isOrthogonal && Math.random() > 0.5,
                                width: 0.5 + Math.random() * 1
                            });
                        }
                    }
                }
            }
            
            // Spawn initial pulses
            for (let i = 0; i < 15; i++) {
                spawnPulse();
            }
        }
        
        function spawnPulse() {
            if (traces.length === 0) return;
            const t = traces[Math.floor(Math.random() * traces.length)];
            const r = Math.random();
            pulses.push({
                trace: t,
                progress: 0,
                speed: 0.003 + Math.random() * 0.007,
                color: r > 0.6 ? '#3b82f6' : r > 0.25 ? '#818cf8' : '#6366f1',
                size: 1.5 + Math.random() * 2
            });
        }
        
        function draw() {
            ctx.clearRect(0, 0, w, h);
            
            // Draw traces
            ctx.lineCap = 'round';
            for (const t of traces) {
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(59, 130, 246, 0.06)';
                ctx.lineWidth = t.width;
                
                if (t.bend) {
                    const mx = t.x2;
                    const my = t.y1;
                    ctx.moveTo(t.x1, t.y1);
                    ctx.lineTo(mx, my);
                    ctx.lineTo(t.x2, t.y2);
                } else {
                    ctx.moveTo(t.x1, t.y1);
                    ctx.lineTo(t.x2, t.y2);
                }
                ctx.stroke();
            }
            
            // Draw nodes
            for (const n of nodes) {
                if (n.type === 'chip') {
                    // IC chip - small rectangle
                    const s = n.size * 2;
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                    ctx.strokeStyle = 'rgba(99, 102, 241, 0.18)';
                    ctx.lineWidth = 0.5;
                    ctx.fillRect(n.x - s, n.y - s * 0.6, s * 2, s * 1.2);
                    ctx.strokeRect(n.x - s, n.y - s * 0.6, s * 2, s * 1.2);
                    // Pins
                    for (let p = 0; p < 3; p++) {
                        const px = n.x - s + (p + 0.5) * (s * 2 / 3);
                        ctx.fillStyle = 'rgba(129, 140, 248, 0.22)';
                        ctx.fillRect(px - 1, n.y - s * 0.6 - 3, 2, 3);
                        ctx.fillRect(px - 1, n.y + s * 0.6, 2, 3);
                    }
                } else if (n.type === 'junction') {
                    // Solder pad
                    ctx.beginPath();
                    ctx.arc(n.x, n.y, n.size, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(99, 102, 241, 0.12)';
                    ctx.fill();
                    ctx.strokeStyle = 'rgba(129, 140, 248, 0.2)';
                    ctx.lineWidth = 0.5;
                    ctx.stroke();
                } else {
                    // Via / small node
                    ctx.beginPath();
                    ctx.arc(n.x, n.y, n.size, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.07)';
                    ctx.fill();
                }
            }
            
            // Draw and update pulses (energy flowing through traces)
            for (let i = pulses.length - 1; i >= 0; i--) {
                const p = pulses[i];
                p.progress += p.speed;
                
                if (p.progress >= 1) {
                    pulses.splice(i, 1);
                    spawnPulse();
                    continue;
                }
                
                const t = p.trace;
                let px, py;
                
                if (t.bend) {
                    const mx = t.x2, my = t.y1;
                    if (p.progress < 0.5) {
                        const pp = p.progress * 2;
                        px = t.x1 + (mx - t.x1) * pp;
                        py = t.y1 + (my - t.y1) * pp;
                    } else {
                        const pp = (p.progress - 0.5) * 2;
                        px = mx + (t.x2 - mx) * pp;
                        py = my + (t.y2 - my) * pp;
                    }
                } else {
                    px = t.x1 + (t.x2 - t.x1) * p.progress;
                    py = t.y1 + (t.y2 - t.y1) * p.progress;
                }
                
                // Glow â€” map hex to rgba prefix for clean interpolation
                const glowMap = {'#3b82f6':'rgba(59,130,246,','#818cf8':'rgba(129,140,248,','#6366f1':'rgba(99,102,241,'};
                const glowBase = glowMap[p.color] || 'rgba(59,130,246,';
                const gradient = ctx.createRadialGradient(px, py, 0, px, py, p.size * 6);
                gradient.addColorStop(0, glowBase + '0.5)');
                gradient.addColorStop(1, 'transparent');
                ctx.beginPath();
                ctx.arc(px, py, p.size * 6, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();

                // Core dot
                ctx.beginPath();
                ctx.arc(px, py, p.size, 0, Math.PI * 2);
                ctx.fillStyle = glowBase + '0.9)';
                ctx.fill();
            }
            
            requestAnimationFrame(draw);
        }
        
        window.addEventListener('resize', resize);
        resize();
        draw();
    })();
    </script>

    <!-- Council's Tasks Modal -->
    <div id="councilTasksModal" class="modal" onclick="if(event.target === this) closeCouncilTasks()">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeCouncilTasks()">&times;</span>
            <h2>ðŸ¤– Council's Tasks</h2>
            <div class="subtitle">AI Agents + Allen - Executive Team Work</div>
            <div id="councilTasksContent" style="margin-top: 20px;">
                <div style="text-align: center; color: #888; padding: 40px;">Loading tasks...</div>
            </div>
        </div>
    </div>

    <!-- Mark's Tasks Modal -->
    <div id="markTasksModal" class="modal" onclick="if(event.target === this) closeMarkTasks()">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeMarkTasks()">&times;</span>
            <h2>ðŸ‘¤ Mark's Tasks</h2>
            <div class="subtitle">Your Review & Decision Items</div>
            <div id="markTasksContent" style="margin-top: 20px;">
                <div style="text-align: center; color: #888; padding: 40px;">Loading tasks...</div>
            </div>
        </div>
    </div>

    <!-- SnapToSell Tasks Modal -->
    <div id="snapTasksModal" class="modal" onclick="if(event.target === this) closeSnapTasks()">
        <div class="modal-content" style="max-width: 1020px; width: 95%;">
            <span class="modal-close" onclick="closeSnapTasks()">&times;</span>
            <h2>ðŸ”· SnapToSell Tasks</h2>
            <div class="subtitle">Dev Board â€” Mark Â· Vigen Â· Arnold</div>

            <!-- Scoreboard -->
            <div style="display:flex;gap:20px;margin:18px 0 6px;padding:16px 20px;background:rgba(15,23,42,0.7);border-radius:10px;border:1px solid rgba(59,130,246,0.15);">
                <div style="flex:1;">
                    <div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;margin-bottom:8px;">
                        <span style="color:#f8fafc;font-weight:700;">ðŸŸ  Vigen â€” CTO / Core Eng</span>
                        <span id="snap-vigen-score" style="color:#94a3b8;font-size:12px;">â€”</span>
                    </div>
                    <div style="height:6px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;">
                        <div id="snap-vigen-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#f97316,#fb923c);border-radius:3px;transition:width 0.5s ease;"></div>
                    </div>
                </div>
                <div style="width:1px;background:rgba(255,255,255,0.06);"></div>
                <div style="flex:1;">
                    <div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;margin-bottom:8px;">
                        <span style="color:#f8fafc;font-weight:700;">ðŸŸ¢ Arnold â€” Frontend / Dev Support</span>
                        <span id="snap-arnold-score" style="color:#94a3b8;font-size:12px;">â€”</span>
                    </div>
                    <div style="height:6px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;">
                        <div id="snap-arnold-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#4ade80);border-radius:3px;transition:width 0.5s ease;"></div>
                    </div>
                </div>
            </div>
            <div id="snap-last-synced" style="font-size:11px;color:#475569;text-align:right;margin-bottom:16px;">Syncingâ€¦</div>

            <!-- Task sections -->
            <div id="snapTasksContent" style="margin-top:4px;">
                <div style="text-align:center;color:#888;padding:40px;">Loading tasksâ€¦</div>
            </div>
        </div>
    </div>

    <!-- Deliverables Review Modal -->
    <div id="deliverablesModal" class="modal" onclick="if(event.target === this) closeDeliverables()">
        <div class="modal-content" style="max-width: 1000px; width: 95%;">
            <span class="modal-close" onclick="closeDeliverables()">&times;</span>
            <h2>ðŸ“‹ Review Queue</h2>
            <div class="subtitle">Allen's Deliverables Pending Your Review</div>
            <div id="deliverablesContent" style="margin-top: 20px;">
                <div style="text-align: center; color: #888; padding: 40px;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./tasks-addon.js"></script>
    <script src="./deliverables-review.js"></script>
    <script>
    // ===== SIDEBAR POPULATION =====
    async function populateSidebar() {
        await Promise.all([populateSidebarAgents(), populateSidebarTasks(), loadOverviewPanels()]);
    }

    async function loadOverviewPanels() {
        await Promise.all([loadOverviewTasks(), loadOverviewAgents()]);
    }

    async function loadOverviewTasks() {
        const el = document.getElementById('overview-task-feed');
        if (!el) return;
        try {
            const resp = await fetch(`${SUPABASE_URL}/rest/v1/agent_tasks?select=id,from_agent,to_agent,task_description,priority,status,created_at&status=neq.done&order=created_at.desc&limit=12`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            if (!resp.ok) throw new Error('fetch failed');
            const tasks = await resp.json();
            if (!tasks.length) {
                el.innerHTML = '<div style="font-size:13px;color:#475569;text-align:center;padding:24px 0;">No active tasks â€” the Council is idle ðŸŽ‰</div>';
                return;
            }
            const agentNames = {
                madison:'Madison', cos:'COS', ceo:'CEO', coo:'COO',
                cto:'Marcus', cmo:'Alexis', cfo:'CFO', cro:'CRO',
                legal:'Legal', media:'Media', intel:'Intel', hr:'HR',
                comms:'Comms', mark:'Mark', allen:'Allen'
            };
            el.innerHTML = tasks.map(t => {
                const from = agentNames[t.from_agent] || t.from_agent || '?';
                const to   = agentNames[t.to_agent]   || t.to_agent   || '?';
                const preview = (t.task_description || '').substring(0, 90);
                return `<div class="qt-item">
                    <div class="qt-dot ${t.status}"></div>
                    <div class="qt-body">
                        <div style="font-size:11px;font-weight:600;color:#94a3b8;margin-bottom:2px;">${from} â†’ ${to}</div>
                        ${preview}${t.task_description && t.task_description.length > 90 ? 'â€¦' : ''}
                        <div class="qt-meta">${t.priority ? t.priority.toUpperCase() : 'MEDIUM'} Â· ${t.status.replace('_',' ')}</div>
                    </div>
                </div>`;
            }).join('');
        } catch(e) {
            el.innerHTML = '<div style="font-size:12px;color:#ef4444;padding:12px 0;">Could not load tasks</div>';
        }
    }

    async function loadOverviewAgents() {
        const el = document.getElementById('overview-agent-list');
        if (!el) return;
        const agentList = [
            { slug:'cos',     name:'Chief of Staff',    title:'Executive Operations' },
            { slug:'ceo',     name:'CEO',               title:'Strategic Direction' },
            { slug:'coo',     name:'COO',               title:'Operational Excellence' },
            { slug:'cto',     name:'Marcus Steele',     title:'CTO â€” Tech Architecture' },
            { slug:'cmo',     name:'Alexis Monroe',     title:'CMO â€” Marketing Strategy' },
            { slug:'cfo',     name:'CFO',               title:'Financial Oversight' },
            { slug:'cro',     name:'CRO',               title:'Revenue & Funnels' },
            { slug:'legal',   name:'Legal',             title:'Compliance & Contracts' },
            { slug:'media',   name:'Media Director',    title:'Content & Social' },
            { slug:'intel',   name:'Intelligence',      title:'Social Listening' },
            { slug:'hr',      name:'HR',                title:'Culture & Recruiting' },
            { slug:'comms',   name:'Communications',    title:'Response Protocols' },
            { slug:'madison', name:'Madison Harper',    title:'Book Marketing Director' }
        ];
        el.innerHTML = agentList.map(a => `
            <div class="agent-ql-item" onclick="openAgentDetail('${a.slug}')">
                <div class="agent-ql-dot"></div>
                <div class="agent-ql-name">${a.name}</div>
                <div class="agent-ql-role">${a.title}</div>
            </div>`).join('');
    }

    async function populateSidebarAgents() {
        try {
            const { data, error } = await supabase
                .from('agents')
                .select('slug, name, title, status')
                .order('priority_order');
            if (error) throw error;

            const agentSlugs = {
                madison: 'Madison Harper', cos: 'Chief of Staff', ceo: 'CEO',
                coo: 'COO', cto: 'Marcus Steele', cmo: 'Alexis Monroe',
                cfo: 'CFO', cro: 'CRO', legal: 'Legal', media: 'Media Director',
                intel: 'Intelligence', hr: 'HR', comms: 'Communications'
            };

            const agents = data && data.length ? data : Object.entries(agentSlugs).map(([slug, name]) => ({
                slug, name, title: '', status: 'active'
            }));

            const html = agents.map(a => `
                <div class="sidebar-agent" onclick="openAgentDetail('${a.slug}')">
                    <div class="agent-dot"></div>
                    <div class="sidebar-agent-info">
                        <div class="sidebar-agent-name">${a.name || a.slug}</div>
                        <div class="sidebar-agent-role">${(a.title || '').substring(0, 35)}</div>
                    </div>
                </div>`).join('');

            document.getElementById('sidebar-agent-list').innerHTML = html || '<div class="sidebar-empty">No agents found</div>';
        } catch(e) {
            document.getElementById('sidebar-agent-list').innerHTML = '<div class="sidebar-empty">Could not load agents</div>';
        }
    }

    async function populateSidebarTasks() {
        try {
            const { data, error } = await supabase
                .from('agent_tasks')
                .select('id, from_agent, to_agent, task_description, priority, status, created_at')
                .neq('status', 'done')
                .order('created_at', { ascending: false })
                .limit(25);
            if (error) throw error;

            if (!data || !data.length) {
                document.getElementById('sidebar-task-feed').innerHTML = '<div class="sidebar-empty">No active tasks</div>';
                return;
            }

            const agentNames = {
                madison: 'Madison', cos: 'COS', ceo: 'CEO', coo: 'COO',
                cto: 'Marcus', cmo: 'Alexis', cfo: 'CFO', cro: 'CRO',
                legal: 'Legal', media: 'Media', intel: 'Intel', hr: 'HR',
                comms: 'Comms', mark: 'Mark', allen: 'Allen'
            };

            const html = data.map(t => {
                const from = agentNames[t.from_agent] || t.from_agent || '?';
                const to = agentNames[t.to_agent] || t.to_agent || '?';
                const preview = (t.task_description || '').substring(0, 80);
                const p = t.priority || 'medium';
                return `<div class="sidebar-task-item" onclick="showTaskModal && showTaskModal('${t.id}')">
                    <div class="sidebar-task-agents">${from} â†’ ${to}</div>
                    <div class="sidebar-task-text">${preview}${t.task_description?.length > 80 ? '...' : ''}</div>
                    <span class="sidebar-task-priority priority-${p}">${p}</span>
                </div>`;
            }).join('');

            document.getElementById('sidebar-task-feed').innerHTML = html;
        } catch(e) {
            document.getElementById('sidebar-task-feed').innerHTML = '<div class="sidebar-empty">Could not load tasks</div>';
        }
    }

    // Call sidebar population + usage data after login
    const _origShowDashboard = window.showDashboard;
    window.showDashboard = function() {
        if (_origShowDashboard) _origShowDashboard();
        setTimeout(populateSidebar, 500);
        setTimeout(function() { if (typeof loadUsage === 'function') loadUsage(); }, 700);
    };

    // Auto-refresh sidebar every 60 seconds
    setInterval(() => {
        if (document.getElementById('dashboard').style.display !== 'none') {
            populateSidebar();
        }
    }, 60000);

    // ===== API USAGE WIDGET =====
    let usageData = null;
    let usageView = 'tokens';

    async function loadUsage() {
        try {
            const resp = await fetch('./api/usage.json?' + Date.now());
            usageData = await resp.json();
            renderUsage();
        } catch(e) { console.log('Usage load failed:', e); }
    }

    function toggleUsageView(view) {
        usageView = view;
        document.getElementById('toggle-tokens').style.background = view === 'tokens' ? 'rgba(59,130,246,0.2)' : 'transparent';
        document.getElementById('toggle-tokens').style.color = view === 'tokens' ? '#60a5fa' : '#8899aa';
        document.getElementById('toggle-tokens').style.borderColor = view === 'tokens' ? 'rgba(59,130,246,0.3)' : 'rgba(255,255,255,0.1)';
        document.getElementById('toggle-dollars').style.background = view === 'dollars' ? 'rgba(59,130,246,0.2)' : 'transparent';
        document.getElementById('toggle-dollars').style.color = view === 'dollars' ? '#60a5fa' : '#8899aa';
        document.getElementById('toggle-dollars').style.borderColor = view === 'dollars' ? 'rgba(59,130,246,0.3)' : 'rgba(255,255,255,0.1)';
        renderUsage();
    }

    function fmtTokens(n) {
        if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
        if (n >= 1000) return (n/1000).toFixed(1) + 'K';
        return n.toString();
    }

    function renderUsage() {
        if (!usageData) return;
        const t = usageData.totals;
        const p = usageData.pricing;
        if (usageView === 'tokens') {
            document.getElementById('usage-total').textContent = fmtTokens(t.totalTokens);
            document.getElementById('usage-input').textContent = fmtTokens(t.input);
            document.getElementById('usage-output').textContent = fmtTokens(t.output);
            document.getElementById('usage-cache').textContent = fmtTokens(t.cacheRead);
            document.getElementById('usage-calls').textContent = t.calls.toLocaleString();
        } else {
            const costIn = (t.input / 1e6) * p.inputPerMTok;
            const costOut = (t.output / 1e6) * p.outputPerMTok;
            const costCR = (t.cacheRead / 1e6) * p.cacheReadPerMTok;
            document.getElementById('usage-total').textContent = '$' + t.totalCost.toFixed(2);
            document.getElementById('usage-input').textContent = '$' + costIn.toFixed(2);
            document.getElementById('usage-output').textContent = '$' + costOut.toFixed(2);
            document.getElementById('usage-cache').textContent = '$' + costCR.toFixed(2);
            document.getElementById('usage-calls').textContent = t.calls.toLocaleString();
        }
        // Daily bar chart
        const daily = usageData.daily;
        const maxVal = Math.max(...daily.map(d => usageView === 'tokens' ? d.tokens : d.cost));
        const bars = daily.map(d => {
            const val = usageView === 'tokens' ? d.tokens : d.cost;
            const pct = maxVal > 0 ? (val / maxVal) * 100 : 0;
            const label = d.date.slice(5);
            const display = usageView === 'tokens' ? fmtTokens(val) : '$' + val.toFixed(2);
            return '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;">' +
                '<div style="font-size:9px;color:#8899aa;">' + display + '</div>' +
                '<div style="width:100%;background:rgba(59,130,246,0.35);border-radius:3px;height:' + Math.max(pct * 0.5, 2) + 'px;"></div>' +
                '<div style="font-size:9px;color:#556677;">' + label + '</div></div>';
        }).join('');
        document.getElementById('usage-daily').innerHTML = bars;
        const updated = new Date(usageData.generated);
        document.getElementById('usage-updated').textContent = 'Updated: ' + updated.toLocaleString();

        // Also update the compact metric card in the overview header
        const apiCostEl = document.getElementById('api-cost-display');
        const apiCallsEl = document.getElementById('api-calls-display');
        if (apiCostEl) apiCostEl.textContent = '$' + (t.totalCost || 0).toFixed(2);
        if (apiCallsEl) apiCallsEl.textContent = (t.calls || 0).toLocaleString() + ' calls';
    }

    // Load usage on dashboard open
    const origLogin = window.login;
    if (typeof origLogin === 'function') {
        window.login = function() { origLogin.apply(this, arguments); setTimeout(loadUsage, 500); };
    }
    if (document.getElementById('dashboard').style.display !== 'none') loadUsage();

</script>

<!-- ============================================================
     SNAPTOSELL TASKS
     Data: Supabase `snaptosell_tasks` table
     Slack Canvas: F0AH7UAFEGZ  |  Channel: #all-snaptosell (C0A9P7ENEFL)
     Poll interval: 3 minutes
     Table columns: id, owner (mark/vigen/arnold), task, status
                    (not_started/in_progress/blocked/done),
                    category, notes, created_at
============================================================ -->
<script>
// ---- Status config ----
const SNAP_STATUS = {
    not_started: { label: 'Not Started', color: '#6b7280', bg: 'rgba(107,114,128,0.15)' },
    in_progress:  { label: 'In Progress', color: '#3b82f6', bg: 'rgba(59,130,246,0.15)'  },
    blocked:      { label: 'Blocked',     color: '#ef4444', bg: 'rgba(239,68,68,0.15)'   },
    done:         { label: 'Done',        color: '#22c55e', bg: 'rgba(34,197,94,0.15)'   },
};

let _snapPollTimer = null;

// ---- Open / Close ----
function showSnapTasks() {
    const modal = document.getElementById('snapTasksModal');
    if (!modal) return;
    modal.style.display = 'flex';
    loadSnapTasks();
    if (!_snapPollTimer) {
        _snapPollTimer = setInterval(loadSnapTasks, 3 * 60 * 1000); // 3-min poll
    }
}

function closeSnapTasks() {
    const modal = document.getElementById('snapTasksModal');
    if (modal) modal.style.display = 'none';
    if (_snapPollTimer) { clearInterval(_snapPollTimer); _snapPollTimer = null; }
}

// ---- Fetch from Supabase ----
async function loadSnapTasks() {
    const syncEl = document.getElementById('snap-last-synced');
    try {
        const resp = await fetch(
            `${SUPABASE_URL}/rest/v1/snaptosell_tasks?select=*&order=created_at.asc`,
            { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
        );
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const tasks = await resp.json();
        renderSnapTasks(tasks);
        if (syncEl) syncEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
    } catch(err) {
        console.warn('[SnapTasks] fetch failed:', err.message);
        _renderSnapEmpty();
        if (syncEl) syncEl.textContent = 'Could not connect';
    }
}

// ---- Scoreboard ----
function _updateSnapBar(person, tasks) {
    const done  = tasks.filter(t => t.status === 'done').length;
    const total = tasks.length;
    const pct   = total > 0 ? Math.round((done / total) * 100) : 0;
    const scoreEl = document.getElementById('snap-' + person + '-score');
    const barEl   = document.getElementById('snap-' + person + '-bar');
    if (scoreEl) scoreEl.textContent = total > 0 ? done + '/' + total + ' (' + pct + '%)' : 'No tasks';
    if (barEl)   barEl.style.width   = pct + '%';
}

// ---- Status badge ----
function _snapBadge(status) {
    const s = SNAP_STATUS[status] || SNAP_STATUS.not_started;
    const label = status === 'done' ? 'Done \u2705' : s.label;
    return '<span style="display:inline-flex;align-items:center;padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600;background:' + s.bg + ';color:' + s.color + ';white-space:nowrap;">' + label + '</span>';
}

// ---- Render one status group within a section ----
function _renderSnapGroup(label, items) {
    if (!items.length) return '';
    return '<div style="margin-bottom:14px;">' +
        '<div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#475569;margin-bottom:8px;">' + label + ' (' + items.length + ')</div>' +
        items.map(function(t) {
            var borderColor = (SNAP_STATUS[t.status] || SNAP_STATUS.not_started).color;
            return '<div class="detail-task" style="border-left:4px solid ' + borderColor + ';margin-bottom:8px;">' +
                '<div class="detail-task-header">' +
                    '<span class="detail-task-from" style="font-weight:500;color:#e2e8f0;">' + (t.task || t.title || 'Untitled') + '</span>' +
                    _snapBadge(t.status || 'not_started') +
                '</div>' +
                (t.notes    ? '<div class="detail-task-notes" style="font-size:0.83em;color:#94a3b8;margin-top:6px;font-style:italic;">' + t.notes + '</div>' : '') +
                (t.category ? '<div style="font-size:11px;color:#475569;margin-top:4px;">\uD83D\uDCC1 ' + t.category + '</div>' : '') +
            '</div>';
        }).join('') +
    '</div>';
}

// ---- Render one owner section ----
function _renderSnapSection(icon, title, tasks) {
    var inProgress  = tasks.filter(function(t){ return (t.status || 'not_started') === 'in_progress'; });
    var blocked     = tasks.filter(function(t){ return (t.status || 'not_started') === 'blocked'; });
    var notStarted  = tasks.filter(function(t){ return !t.status || t.status === 'not_started'; });
    var done        = tasks.filter(function(t){ return t.status === 'done'; });
    return '<div class="task-section" style="margin-bottom:28px;">' +
        '<h3 style="color:#f8fafc;font-size:14px;font-weight:700;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.07);">' + icon + ' ' + title + '</h3>' +
        (tasks.length === 0
            ? '<div class="empty-state" style="font-size:13px;color:#475569;padding:8px 0;">No tasks assigned</div>'
            : _renderSnapGroup('\uD83D\uDD25 In Progress', inProgress) +
              _renderSnapGroup('\uD83D\uDEAB Blocked',     blocked)     +
              _renderSnapGroup('\u2B1C Not Started',       notStarted)  +
              _renderSnapGroup('\u2705 Done',              done)
        ) +
    '</div>';
}

// ---- Main render ----
function renderSnapTasks(tasks) {
    var content = document.getElementById('snapTasksContent');
    if (!content) return;

    var markTasks   = tasks.filter(function(t){ return t.owner === 'mark'; });
    var vigenTasks  = tasks.filter(function(t){ return t.owner === 'vigen'; });
    var arnoldTasks = tasks.filter(function(t){ return t.owner === 'arnold'; });

    _updateSnapBar('vigen',  vigenTasks);
    _updateSnapBar('arnold', arnoldTasks);

    if (!tasks.length) {
        content.innerHTML =
            '<div style="text-align:center;padding:48px 20px;">' +
                '<div style="font-size:36px;margin-bottom:14px;">\uD83D\uDD37</div>' +
                '<div style="color:#f8fafc;font-size:15px;font-weight:700;margin-bottom:8px;">No tasks yet</div>' +
                '<div style="color:#475569;font-size:13px;max-width:440px;margin:0 auto;line-height:1.6;">' +
                    'Add rows to <code style="background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:4px;color:#93c5fd;">snaptosell_tasks</code> in Supabase.<br><br>' +
                    '<span style="color:#60a5fa;">Slack Canvas sync:</span> Canvas ' +
                    '<code style="background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:4px;color:#93c5fd;">F0AH7UAFEGZ</code>' +
                    ' in <code style="background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:4px;color:#93c5fd;">#all-snaptosell</code>' +
                    ' \u2014 add <code style="color:#93c5fd;">SLACK_BOT_TOKEN</code> to .env to enable.' +
                '</div>' +
            '</div>';
        return;
    }

    content.innerHTML =
        _renderSnapSection('\uD83D\uDD35', 'MARK \u2014 Business &amp; Product',   markTasks)  +
        _renderSnapSection('\uD83D\uDFE0', 'VIGEN \u2014 CTO / Core Engineering',  vigenTasks) +
        _renderSnapSection('\uD83D\uDFE2', 'ARNOLD \u2014 Frontend / Dev Support', arnoldTasks);
}

function _renderSnapEmpty() {
    var content = document.getElementById('snapTasksContent');
    if (content) content.innerHTML =
        '<div style="text-align:center;padding:48px 20px;color:#475569;font-size:13px;">' +
            'Could not load tasks.<br>Check Supabase connection.' +
        '</div>';
    ['vigen', 'arnold'].forEach(function(p) {
        var s = document.getElementById('snap-' + p + '-score'); if (s) s.textContent = '\u2014';
        var b = document.getElementById('snap-' + p + '-bar');   if (b) b.style.width = '0%';
    });
}
</script>